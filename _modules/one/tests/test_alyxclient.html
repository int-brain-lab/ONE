

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>one.tests.test_alyxclient &mdash; ONE  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/style.css" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
      <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ONE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Using ONE to access data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../one_reference.html">Introduction to ONE (Open Neurophysiology Environment)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../one_installation.html">ONE installation and setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/one_quickstart.html">ONE Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/one_search/one_search.html">Searching with ONE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/one_list/one_list.html">Listing with ONE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/one_load/one_load.html">Loading with ONE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/experiment_ids.html">Experiment IDs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using ONE with Alyx</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/one_modes.html">ONE API modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/one_advanced/one_advanced.html">ONE REST queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/useful_alyx_queries.html">Useful Alyx REST queries</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using ONE to share data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/data_sharing.html">Releasing data with ONE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/recording_data_access.html">Recording data access</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/recording_data_access.html#Data-reproducibility">Data reproducibility</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ALF</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../alf_intro.html">ALyx Filenames (ALF)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/alyx_files.html">Listing Alyx Filenames</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/alf_paths.html">ALF Path objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/datasets_and_types.html">Datasets and their types</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ONE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">one.tests.test_alyxclient</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for one.tests.test_alyxclient</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Unit tests for the one.webclient module.&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">unittest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">unittest</span><span class="w"> </span><span class="kn">import</span> <span class="n">mock</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">urllib.parse</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">weakref</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">one.webclient</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">wc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">one.params</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">iblutil.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">hashfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">iblutil.io.params</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">iopar</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">one.tests</span><span class="w"> </span><span class="kn">import</span> <span class="n">OFFLINE_ONLY</span><span class="p">,</span> <span class="n">TEST_DB_1</span><span class="p">,</span> <span class="n">TEST_DB_2</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">one.tests</span><span class="w"> </span><span class="kn">import</span> <span class="n">util</span>

<span class="n">par</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Init connection to the database</span>
<span class="n">ac</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">AlyxClient</span><span class="p">(</span><span class="o">**</span><span class="n">TEST_DB_1</span><span class="p">)</span>
<span class="c1"># Remove /public from data server url</span>
<span class="k">if</span> <span class="s1">&#39;public&#39;</span> <span class="ow">in</span> <span class="n">ac</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">HTTP_DATA_SERVER</span><span class="p">:</span>
    <span class="n">ac</span><span class="o">.</span><span class="n">_par</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;HTTP_DATA_SERVER&#39;</span><span class="p">,</span> <span class="n">ac</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">HTTP_DATA_SERVER</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>


<div class="viewcode-block" id="TestRestDocumentation">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestRestDocumentation">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestRestDocumentation</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests for AlyxClient REST API schema parsing and printing.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestRestDocumentation.setUp">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestRestDocumentation.setUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">path_fixtures</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;fixtures&#39;</span><span class="p">,</span> <span class="s1">&#39;rest_responses&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_fixtures</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;coreapi.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">rest_scheme</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheme_coreapi</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">RestSchemeCoreApi</span><span class="p">(</span><span class="n">rest_scheme</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path_fixtures</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;openapiv3.json&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">rest_scheme</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheme_openapi</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">RestSchemeOpenApi</span><span class="p">(</span><span class="n">rest_scheme</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestRestDocumentation.test_rest_schema_core_api">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestRestDocumentation.test_rest_schema_core_api">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_rest_schema_core_api</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test parsing of coreapi REST schema.&quot;&quot;&quot;</span>
        <span class="c1"># test the list of endpoints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme_openapi</span><span class="o">.</span><span class="n">endpoints</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme_coreapi</span><span class="o">.</span><span class="n">endpoints</span><span class="p">))</span>
        <span class="c1"># test the list of actions for each endpoint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme_coreapi</span><span class="o">.</span><span class="n">actions</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">)),</span>
            <span class="p">{</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;partial_update&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme_openapi</span><span class="o">.</span><span class="n">actions</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">)),</span>
            <span class="p">{</span><span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="s1">&#39;partial_update&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="c1"># test getting the URL for each endpoint/action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme_openapi</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">),</span> <span class="s1">&#39;/sessions/</span><span class="si">{id}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme_coreapi</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">),</span> <span class="s1">&#39;/sessions/</span><span class="si">{id}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># test getting the parameters for each endpoint/action</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme_openapi</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">,</span> <span class="s1">&#39;partial_update&#39;</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">19</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme_coreapi</span><span class="o">.</span><span class="n">fields</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">,</span> <span class="s1">&#39;partial_update&#39;</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">19</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme_openapi</span><span class="o">.</span><span class="n">field_names</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">,</span> <span class="s1">&#39;partial_update&#39;</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">19</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme_coreapi</span><span class="o">.</span><span class="n">field_names</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">,</span> <span class="s1">&#39;partial_update&#39;</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">19</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestRestDocumentation.test_print_endpoint_info">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestRestDocumentation.test_print_endpoint_info">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_print_endpoint_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test endpoint query params are printed when calling AlyxClient.rest without action.&quot;&quot;&quot;</span>
        <span class="c1"># Check behaviour when endpoint invalid</span>
        <span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;foobar&#39;</span>
        <span class="k">for</span> <span class="n">scheme</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scheme_openapi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme_coreapi</span><span class="p">]:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="n">scheme</span><span class="o">=</span><span class="n">scheme</span><span class="p">):</span>
                <span class="k">with</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;sys.stdout&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">:</span>
                    <span class="n">scheme</span><span class="o">.</span><span class="n">print_endpoint_info</span><span class="p">(</span><span class="n">endpoint</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="sa">f</span><span class="s1">&#39;&quot;</span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s1">&quot; does not exist&#39;</span><span class="p">)</span>
                <span class="c1"># Check returns endpoint info as well as printing</span>
                <span class="k">with</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;sys.stdout&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">:</span>
                    <span class="n">scheme</span><span class="o">.</span><span class="n">print_endpoint_info</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">,</span> <span class="s1">&#39;partial_update&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="s1">&#39;parent_session&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="s1">&#39;extended_qc&#39;</span><span class="p">)</span>

                <span class="k">with</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;sys.stdout&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">:</span>
                    <span class="n">scheme</span><span class="o">.</span><span class="n">print_endpoint_info</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="s1">&#39;partial_update&#39;</span><span class="p">)</span>

                <span class="k">with</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;sys.stdout&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">:</span>
                    <span class="n">scheme</span><span class="o">.</span><span class="n">print_endpoint_info</span><span class="p">(</span><span class="s1">&#39;insertions&#39;</span><span class="p">,</span> <span class="s1">&#39;erase&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span>
                                     <span class="s1">&#39;Endpoint &quot;insertions&quot; does not have action &quot;erase&quot;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestRestDocumentation.test_alyx_client_methods">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestRestDocumentation.test_alyx_client_methods">[docs]</a>
    <span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="n">OFFLINE_ONLY</span><span class="p">,</span> <span class="s1">&#39;online only test&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_alyx_client_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test AlyxClient.list_endpoints and AlyxClient.print_endpoint_info.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;sys.stdout&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">list_endpoints</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="s1">&#39;sessions&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;sys.stdout&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">:</span>
            <span class="n">ac</span><span class="o">.</span><span class="n">print_endpoint_info</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(),</span> <span class="s1">&#39;partial_update&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestRestDocumentation.test_schema_support">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestRestDocumentation.test_schema_support">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_schema_support</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that both coreapi and openapiv3 REST schemas are supported.&quot;&quot;&quot;</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">AlyxClient</span><span class="p">(</span><span class="o">**</span><span class="n">TEST_DB_1</span><span class="p">)</span>
        <span class="c1"># The new alyx uses openapiv3 schema on the /api/schema endpoint</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme_openapi</span><span class="o">.</span><span class="n">_rest_scheme</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">output</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_get</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">ac</span><span class="o">.</span><span class="n">_rest_schemes</span> <span class="ow">is</span> <span class="kc">None</span>  <span class="c1"># Ensure not cached</span>
            <span class="n">scheme</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">rest_schemes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">wc</span><span class="o">.</span><span class="n">RestSchemeOpenApi</span><span class="p">)</span>
        <span class="n">mock_get</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="s1">&#39;/api/schema&#39;</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">)</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">_rest_schemes</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Reset cached scheme</span>
        <span class="c1"># Old alyx uses coreapi schema on the /docs endpoint</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">()</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">()</span>
        <span class="n">rep</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">404</span>
        <span class="n">err</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">rep</span>
        <span class="n">responses</span> <span class="o">=</span> <span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scheme_coreapi</span><span class="o">.</span><span class="n">_rest_scheme</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">side_effect</span><span class="o">=</span><span class="n">responses</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_get</span><span class="p">:</span>
            <span class="n">scheme</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">rest_schemes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">scheme</span><span class="p">,</span> <span class="n">wc</span><span class="o">.</span><span class="n">RestSchemeCoreApi</span><span class="p">)</span>
        <span class="c1"># Should try new schema endpoint then fallback to old one</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">mock_get</span><span class="o">.</span><span class="n">call_count</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">endpoints</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mock_get</span><span class="o">.</span><span class="n">call_args_list</span><span class="p">]</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/api/schema&#39;</span><span class="p">,</span> <span class="s1">&#39;/docs&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">endpoints</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
        <span class="c1"># If the status code is not 404, should raise the error</span>
        <span class="n">rep</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">_rest_schemes</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Reset cached scheme</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">side_effect</span><span class="o">=</span><span class="n">err</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">):</span>
            <span class="n">scheme</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">rest_schemes</span></div>
</div>



<div class="viewcode-block" id="TestAuthentication">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestAuthentication">[docs]</a>
<span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="n">OFFLINE_ONLY</span><span class="p">,</span> <span class="s1">&#39;online only test&#39;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestAuthentication</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests for AlyxClient authentication, token storage, login/out methods and user prompts.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestAuthentication.setUp">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestAuthentication.setUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ac</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">AlyxClient</span><span class="p">(</span><span class="o">**</span><span class="n">TEST_DB_2</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestAuthentication.test_authentication">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestAuthentication.test_authentication">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_authentication</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for AlyxClient.authenticate and AlyxClient.is_logged_in property.&quot;&quot;&quot;</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">is_logged_in</span><span class="p">)</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">is_logged_in</span><span class="p">)</span>
        <span class="c1"># Check token removed from cache</span>
        <span class="n">cached_token</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">]),</span> <span class="s1">&#39;TOKEN&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cached_token</span><span class="p">)</span>
        <span class="c1"># Test with pars set</span>
        <span class="n">login_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ALYX_LOGIN&#39;</span><span class="p">,</span> <span class="s1">&#39;ALYX_PWD&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="n">login_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">login_keys</span><span class="p">),</span> <span class="p">(</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">])):</span>
                <span class="n">ac</span><span class="o">.</span><span class="n">_par</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.input&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_input</span><span class="p">:</span>
            <span class="n">ac</span><span class="o">.</span><span class="n">authenticate</span><span class="p">()</span>
            <span class="n">mock_input</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">is_logged_in</span><span class="p">)</span>

        <span class="c1"># When password is None and in silent mode, there should be a warning</span>
        <span class="c1"># followed by a failed login attempt</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">_par</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;ALYX_PWD&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertWarns</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Test using input args</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">_par</span> <span class="o">=</span> <span class="n">iopar</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
            <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ac</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">login_keys</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.input&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_input</span><span class="p">:</span>
            <span class="n">ac</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">],</span> <span class="n">cache_token</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">mock_input</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
        <span class="c1"># Check token not saved in cache</span>
        <span class="n">cached_token</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">]),</span> <span class="s1">&#39;TOKEN&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cached_token</span><span class="p">)</span>
        <span class="c1"># Test user prompts</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">silent</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="p">(</span>
            <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.input&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]),</span>
            <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.webclient.getpass&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]),</span>
        <span class="p">):</span>
            <span class="n">ac</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">cache_token</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">is_logged_in</span><span class="p">)</span>
        <span class="c1"># Check token saved in cache</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">cache_token</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cached_token</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">]),</span> <span class="s1">&#39;TOKEN&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cached_token</span><span class="p">)</span>
        <span class="c1"># Check force flag</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.webclient.getpass&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">mock_pwd</span><span class="p">:</span>
            <span class="n">ac</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">cache_token</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">mock_pwd</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>
        <span class="c1"># If a password is passed, should always force re-authentication</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">()</span>
        <span class="n">rep</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">rep</span><span class="o">.</span><span class="n">json</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">_</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="s1">&#39;abc&#39;</span><span class="p">}</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">is_logged_in</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.webclient.requests.post&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">rep</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">}</span>
            <span class="n">m</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/auth-token&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">expected</span><span class="p">)</span>

        <span class="c1"># Check non-silent double logout</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>  <span class="c1"># Shouldn&#39;t complain</span></div>


<div class="viewcode-block" id="TestAuthentication.test_auth_methods">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestAuthentication.test_auth_methods">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_auth_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test behaviour when calling AlyxClient._generic_request when logged out.&quot;&quot;&quot;</span>
        <span class="c1"># Check that authentication happens when making a logged out request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">is_logged_in</span> <span class="ow">is</span> <span class="kc">False</span>
        <span class="c1"># Set pars for auto login</span>
        <span class="n">login_keys</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ALYX_LOGIN&#39;</span><span class="p">,</span> <span class="s1">&#39;ALYX_PWD&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="n">login_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">login_keys</span><span class="p">),</span> <span class="p">(</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">])):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">_par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

        <span class="c1"># Test generic request</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">_generic_request</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="s1">&#39;/sessions?user=Hamish&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">is_logged_in</span><span class="p">)</span>

        <span class="c1"># Test behaviour when token invalid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">_token</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1NVAL1DT0K3N&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">_headers</span><span class="p">[</span><span class="s1">&#39;Authorization&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Token &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">_token</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">_generic_request</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="s1">&#39;/sessions?user=Hamish&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">is_logged_in</span><span class="p">)</span>

        <span class="c1"># Test download cache tables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">is_logged_in</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cache/info&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">download_cache_tables</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">is_logged_in</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestAuthentication.test_auth_errors">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestAuthentication.test_auth_errors">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_auth_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test behaviour when authentication fails.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>  <span class="c1"># Make sure logged out</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="s1">&#39;wrong_pass&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;user = intbrainlab&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="s1">&#39;wrong_pass&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
        <span class="c1"># Check behaviour when connection error occurs (should mention firewall settings)</span>
        <span class="k">with</span> <span class="p">(</span>
            <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.webclient.requests.post&#39;</span><span class="p">,</span> <span class="n">side_effect</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ConnectionError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">authenticate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;firewall&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
        <span class="c1"># Check behaviour when server error occurs</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Response</span><span class="p">()</span>
        <span class="n">rep</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">500</span>
        <span class="k">with</span> <span class="p">(</span>
            <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.webclient.requests.post&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">rep</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">),</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">authenticate</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="TestJsonFieldMethods">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestJsonFieldMethods">[docs]</a>
<span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="n">OFFLINE_ONLY</span><span class="p">,</span> <span class="s1">&#39;online only test&#39;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestJsonFieldMethods</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests for AlyxClient methods that modify the JSON field of a REST endpoint.</span>

<span class="sd">    These tests are over-engineered in order to test Alyx Django queries with JSON fields.</span>
<span class="sd">    Django queries are also tested in TestRemote.test_search.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestJsonFieldMethods.setUp">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestJsonFieldMethods.setUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ac</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">AlyxClient</span><span class="p">(</span><span class="o">**</span><span class="n">TEST_DB_1</span><span class="p">,</span> <span class="n">cache_rest</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Create new subject and two new sessions</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;0A&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;subjects&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;nickname&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s1">&#39;lab&#39;</span><span class="p">:</span> <span class="s1">&#39;cortexlab&#39;</span><span class="p">})</span>
        <span class="n">sessions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span>
                <span class="s1">&#39;sessions&#39;</span><span class="p">,</span>
                <span class="s1">&#39;create&#39;</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;subject&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s1">&#39;start_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()),</span>
                    <span class="s1">&#39;number&#39;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">999</span><span class="p">),</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;Experiment&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">TEST_DB_1</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]],</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eids</span> <span class="o">=</span> <span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="s1">&#39;sessions&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span> <span class="o">=</span> <span class="s1">&#39;extended_qc&#39;</span>
        <span class="c1"># We filter by key value so we use randint to avoid race condition in concurrent tests</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;low_&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;high_&#39;</span> <span class="o">+</span> <span class="n">i</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_json_field_write</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">written1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">json_field_write</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span>
        <span class="p">)</span>
        <span class="n">written2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">json_field_write</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">written1</span> <span class="o">==</span> <span class="n">written2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">written1</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span><span class="p">)</span>
        <span class="n">data_field</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;low&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span><span class="p">))</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="si">}</span><span class="s1">?&amp;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">data_field</span><span class="si">}</span><span class="s1">__lt,0.5&#39;</span>
        <span class="n">sess_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sess_dict</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_json_field_update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data_field</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;low&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span><span class="p">))</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">json_field_update</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">,</span> <span class="p">{</span><span class="n">data_field</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">modified</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="si">}</span><span class="s1">?&amp;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">data_field</span><span class="si">}</span><span class="s1">__lt,0.5&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_json_field_remove_key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">data_field</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span><span class="p">))</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="si">}</span><span class="s1">?&amp;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">data_field</span><span class="si">}</span><span class="s1">__gte,0.5&#39;</span>
        <span class="n">pre_delete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pre_delete</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">deleted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">json_field_remove_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">eid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">,</span> <span class="n">data_field</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">data_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deleted</span><span class="p">)</span>
        <span class="n">post_delete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">post_delete</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_json_field_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data_field</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;hi&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span><span class="p">))</span>
        <span class="n">deleted</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">json_field_delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">deleted</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="si">}</span><span class="s1">?&amp;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="si">}</span><span class="s1">=</span><span class="si">{</span><span class="n">data_field</span><span class="si">}</span><span class="s1">__gte,0.5&#39;</span>
        <span class="n">ses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ses</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="TestJsonFieldMethods.test_json_methods">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestJsonFieldMethods.test_json_methods">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_json_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for AlyxClient.json_field* methods (write, update, remove_key and delete).&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_json_field_write</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_json_field_update</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_json_field_remove_key</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_json_field_delete</span><span class="p">()</span></div>


<div class="viewcode-block" id="TestJsonFieldMethods.test_empty">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestJsonFieldMethods.test_empty">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for AlyxClient.json_field* methods when JSON field is empty.&quot;&quot;&quot;</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Check behaviour when fields are empty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="s1">&#39;partial_update&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">eid</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
        <span class="c1"># Should return None as no keys exist</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">json_field_remove_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">eid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">modified</span><span class="p">)</span>
        <span class="c1"># Should return data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;some&#39;</span><span class="p">:</span> <span class="mf">0.6</span><span class="p">}</span>
        <span class="n">modified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">json_field_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">eid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">modified</span> <span class="o">==</span> <span class="n">data</span><span class="p">)</span>
        <span class="c1"># Should warn if key not in dict</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;one.webclient&#39;</span><span class="p">),</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">json_field_remove_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">eid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="c1"># Check behaviour when fields not a dict</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="s1">&#39;partial_update&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">eid</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># Update field</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;one.webclient&#39;</span><span class="p">),</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">):</span>
            <span class="n">modified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">json_field_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">eid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">],</span> <span class="n">modified</span><span class="p">)</span>
        <span class="c1"># Remove key</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;one.webclient&#39;</span><span class="p">),</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">):</span>
            <span class="n">modified</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">json_field_remove_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">eid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">modified</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestJsonFieldMethods.test_uuid_serialize">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestJsonFieldMethods.test_uuid_serialize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_uuid_serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check that UUID objects are serialized to JSON.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uid&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dict</span><span class="p">}</span>
        <span class="n">written</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">json_field_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_name</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">written</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="c1"># Encoder should have cast uuid to str</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">written</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uid&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="TestJsonFieldMethods.tearDown">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestJsonFieldMethods.tearDown">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;subjects&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">subj</span><span class="p">[</span><span class="s1">&#39;nickname&#39;</span><span class="p">])</span></div>
</div>



<div class="viewcode-block" id="TestRestCache">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestRestCache">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestRestCache</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tests for REST caching system, the cache decorator and cache flags.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TestRestCache.setUp">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestRestCache.setUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">util</span><span class="o">.</span><span class="n">setup_test_params</span><span class="p">()</span>  <span class="c1"># Ensure test alyx set up</span>
        <span class="n">util</span><span class="o">.</span><span class="n">setup_rest_cache</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">)</span>  <span class="c1"># Copy rest cache fixtures</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;/insertions/b529f2d8-cdae-4d59-aba2-cbd1b5572e36&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">set_up_env</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">)</span>
        <span class="n">one</span><span class="o">.</span><span class="n">webclient</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">_FakeDateTime</span>
        <span class="n">_FakeDateTime</span><span class="o">.</span><span class="n">_now</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">cache_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.rest&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_expiry</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">default_expiry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_mode</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">cache_mode</span></div>


<div class="viewcode-block" id="TestRestCache.test_loads_cached">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestRestCache.test_loads_cached">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_loads_cached</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for one.webclient._cache_response decorator, checks returns cached result.&quot;&quot;&quot;</span>
        <span class="c1"># Check returns cache</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">_cache_response</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">ac</span>  <span class="c1"># Bunch({&#39;base_url&#39;: &#39;https://test.alyx.internationalbrainlab.org&#39;})</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="TestRestCache.test_expired_cache">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestRestCache.test_expired_cache">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_expired_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test behaviour when cached REST query is expired.&quot;&quot;&quot;</span>
        <span class="c1"># Checks expired</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">_cache_response</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="s1">&#39;called&#39;</span><span class="p">)</span>
        <span class="n">_FakeDateTime</span><span class="o">.</span><span class="n">_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="s1">&#39;3001-01-01&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="s1">&#39;called&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestRestCache.test_caches_response">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestRestCache.test_caches_response">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_caches_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test caches query response before returning.&quot;&quot;&quot;</span>
        <span class="c1"># Default expiry time</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">default_expiry</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">_cache_response</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="s1">&#39;called&#39;</span><span class="p">)</span>
        <span class="n">_FakeDateTime</span><span class="o">.</span><span class="n">_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2021</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>  <span class="c1"># Freeze time</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="s1">&#39;/endpoint?id=5&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="s1">&#39;called&#39;</span><span class="p">)</span>

        <span class="c1"># Check cache file created</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;64b5b3476c015e04ee7c4753606b5e967325d34a&#39;</span>
        <span class="n">cache_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">/</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">cache_file</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cache_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">q</span><span class="p">,</span> <span class="n">when</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;called&#39;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">when</span><span class="p">,</span> <span class="s1">&#39;2021-05-13T00:01:00&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestRestCache.test_cache_mode">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestRestCache.test_cache_mode">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_cache_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for AlyxClient.cache_mode property.&quot;&quot;&quot;</span>
        <span class="c1"># With cache mode off, wrapped method should be called even in presence of valid cache</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">cache_mode</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># cache nothing</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">_cache_response</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="s1">&#39;called&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="s1">&#39;called&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestRestCache.test_expiry_param">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestRestCache.test_expiry_param">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_expiry_param</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for expires kwarg in one.webclient._cache_response decorator.&quot;&quot;&quot;</span>
        <span class="c1"># Check expiry param</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">_cache_response</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="s1">&#39;123&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="s1">&#39;/endpoint?id=5&#39;</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="s1">&#39;123&#39;</span><span class="p">)</span>

        <span class="c1"># A second call should yield a new response as cache immediately expired</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">_cache_response</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="s1">&#39;456&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="s1">&#39;/endpoint?id=5&#39;</span><span class="p">,</span> <span class="n">expires</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="s1">&#39;456&#39;</span><span class="p">)</span>

        <span class="c1"># With clobber=True the cache should be overwritten</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">_cache_response</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="s1">&#39;789&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="s1">&#39;/endpoint?id=5&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="s1">&#39;789&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestRestCache.test_cache_returned_on_error">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestRestCache.test_cache_returned_on_error">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_cache_returned_on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test behaviour when connection error occurs and cached response exists.&quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">(</span><span class="n">side_effect</span><span class="o">=</span><span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">())</span>
        <span class="n">wrapped</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">_cache_response</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">_FakeDateTime</span><span class="o">.</span><span class="n">_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="s1">&#39;3001-01-01&#39;</span><span class="p">)</span>  <span class="c1"># Expired</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertWarns</span><span class="p">(</span><span class="ne">RuntimeWarning</span><span class="p">):</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">wrapped</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># With clobber=True exception should be raised</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">):</span>
            <span class="n">wrapped</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestRestCache.test_clear_cache">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestRestCache.test_clear_cache">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_clear_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for AlyxClient.clear_rest_cache.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">clear_rest_cache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)))</span></div>


<div class="viewcode-block" id="TestRestCache.tearDown">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestRestCache.tearDown">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">cache_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache_mode</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">default_expiry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_expiry</span></div>
</div>



<span class="k">class</span><span class="w"> </span><span class="nc">_FakeDateTime</span><span class="p">(</span><span class="n">datetime</span><span class="p">):</span>
    <span class="n">_now</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">now</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_FakeDateTime</span><span class="o">.</span><span class="n">_now</span> <span class="ow">or</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<div class="viewcode-block" id="TestDownloadHTTP">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestDownloadHTTP">[docs]</a>
<span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="n">OFFLINE_ONLY</span><span class="p">,</span> <span class="s1">&#39;online only test&#39;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TestDownloadHTTP</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="TestDownloadHTTP.setUp">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestDownloadHTTP.setUp">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ac</span> <span class="o">=</span> <span class="n">ac</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_data_uuid</span> <span class="o">=</span> <span class="s1">&#39;40af4a49-1b9d-45ec-b443-a151c010ea3c&#39;</span>  <span class="c1"># OpenAlyx dataset</span></div>


<div class="viewcode-block" id="TestDownloadHTTP.test_download_datasets_with_api">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestDownloadHTTP.test_download_datasets_with_api">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_download_datasets_with_api</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ac_public</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">AlyxClient</span><span class="p">(</span><span class="o">**</span><span class="n">TEST_DB_2</span><span class="p">)</span>
        <span class="n">cache_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">cache_dir</span><span class="p">))</span>

        <span class="c1"># Test 1: empty dir, dict mode</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">ac_public</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/datasets/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_data_uuid</span><span class="p">)</span>
        <span class="n">urls</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">dataset_record_to_url</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">urls</span> <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;https://ibl.flatiron&#39;</span><span class="p">)]</span>
        <span class="p">(</span><span class="n">file_name</span><span class="p">,)</span> <span class="o">=</span> <span class="n">ac_public</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">target_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

        <span class="c1"># Test 2: empty dir, list mode</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="n">ac_public</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/datasets?id=&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_data_uuid</span><span class="p">)</span>
        <span class="n">urls</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">dataset_record_to_url</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="p">[</span><span class="n">u</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">urls</span> <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;https://ibl.flatiron&#39;</span><span class="p">)]</span>
        <span class="p">(</span><span class="n">file_name</span><span class="p">,)</span> <span class="o">=</span> <span class="n">ac_public</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">target_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_name</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

        <span class="c1"># Test 3: Log unauthorized error with url (using test alyx)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;data_url&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ac</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/datasets?exists=True&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;file_records&#39;</span><span class="p">])</span>
        <span class="n">old_par</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">_par</span>
        <span class="n">ac</span><span class="o">.</span><span class="n">_par</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;HTTP_DATA_SERVER_PWD&#39;</span><span class="p">,</span> <span class="s1">&#39;foobar&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;one.webclient&#39;</span><span class="p">),</span> <span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span> <span class="k">as</span> <span class="n">log</span><span class="p">:</span>
            <span class="n">raised</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ac</span><span class="o">.</span><span class="n">download_file</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">target_dir</span><span class="o">=</span><span class="n">cache_dir</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">url</span> <span class="ow">in</span> <span class="n">log</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="c1"># Check error message mentions the HTTP_DATA_SERVER params</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;HTTP_DATA_SERVER_PWD&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
                <span class="n">raised</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">raised</span><span class="p">)</span>
                <span class="n">ac</span><span class="o">.</span><span class="n">_par</span> <span class="o">=</span> <span class="n">old_par</span></div>


<div class="viewcode-block" id="TestDownloadHTTP.test_download_datasets">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestDownloadHTTP.test_download_datasets">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_download_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># test downloading a single file</span>
        <span class="n">full_link_to_file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;https://ibl.flatironinstitute.org/public/mrsicflogellab/Subjects/SWC_038/&#39;</span>
            <span class="s1">&#39;2020-07-29/001/alf/probes.description.f67570ac-1e54-4ce1-be5d-de2017a42116.json&#39;</span>
        <span class="p">)</span>
        <span class="n">file_name</span><span class="p">,</span> <span class="n">md5</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">http_download_file</span><span class="p">(</span><span class="n">full_link_to_file</span><span class="p">,</span> <span class="n">return_md5</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">hashfile</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="o">==</span> <span class="n">md5</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">wc</span><span class="o">.</span><span class="n">http_download_file</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="c1"># test downloading a list of files</span>
        <span class="n">links</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">full_link_to_file</span><span class="p">,</span>
            <span class="sa">r</span><span class="s1">&#39;https://ibl.flatironinstitute.org/public/hoferlab/Subjects/SWC_043/&#39;</span>
            <span class="sa">r</span><span class="s1">&#39;2020-09-21/001/alf/probes.description.c4df1eea-c92c-479f-a907-41fa6e770094.json&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">file_list</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">http_download_file_list</span><span class="p">(</span>
            <span class="n">links</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">HTTP_DATA_SERVER_LOGIN</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">par</span><span class="o">.</span><span class="n">HTTP_DATA_SERVER_PWD</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestDownloadHTTP.test_download_cache_tables_auth">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestDownloadHTTP.test_download_cache_tables_auth">[docs]</a>
    <span class="nd">@mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.webclient.zipfile.ZipFile&#39;</span><span class="p">)</span>
    <span class="nd">@mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.webclient.http_download_file&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_download_cache_tables_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">download_file_mock</span><span class="p">,</span> <span class="n">zipfile_mock</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for AlyxClient.download_cache_tables with authentication.</span>

<span class="sd">        NB: This test simply checks that alex is authenticated automatically before</span>
<span class="sd">        downloading the tables.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">_token</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Force re-authentication</span>
            <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="p">,</span> <span class="s1">&#39;authenticate&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">mock_auth</span><span class="p">:</span>
                <span class="c1"># When the URL is different from the database, no need to authenticate</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">download_cache_tables</span><span class="p">(</span><span class="s1">&#39;https://example.com/cache.zip&#39;</span><span class="p">)</span>
                <span class="n">mock_auth</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
                <span class="n">download_file_mock</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
                <span class="n">zipfile_mock</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
                <span class="c1"># When the URL is the same as the database, should authenticate</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">download_cache_tables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="s1">&#39;/cache.zip&#39;</span><span class="p">)</span>
                <span class="n">mock_auth</span><span class="o">.</span><span class="n">assert_called_once</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ac</span><span class="o">.</span><span class="n">_token</span> <span class="o">=</span> <span class="n">token</span></div>
</div>



<div class="viewcode-block" id="TestMisc">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestMisc">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">TestMisc</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<div class="viewcode-block" id="TestMisc.test_update_url_params">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestMisc.test_update_url_params">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_update_url_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for one.webclient.update_url_params.&quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">update_url_params</span><span class="p">(</span><span class="s1">&#39;website.com/?q=&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;pg&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;website.com/?pg=5&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>

        <span class="c1"># Check handles lists</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">update_url_params</span><span class="p">(</span><span class="s1">&#39;website.com?q=xxx&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;pg&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">]})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;website.com?q=xxx&amp;pg=5&amp;foo=bar&amp;foo=baz&#39;</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>

        <span class="c1"># Check encodes special chars; handles partial URL</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;/path?param1=foo bar&#39;</span>
        <span class="n">new_url</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">update_url_params</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;param2&#39;</span><span class="p">:</span> <span class="s1">&#39;#2020-01-03#,#2021-02-01#&#39;</span><span class="p">})</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;/path?param1=foo+bar&amp;param2=%232020-01-03</span><span class="si">%23%</span><span class="s1">2C%232021-02-01%23&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">new_url</span><span class="p">)</span>

        <span class="c1"># Without pars</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">wc</span><span class="o">.</span><span class="n">update_url_params</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="p">{}))</span></div>


<div class="viewcode-block" id="TestMisc.test_validate_file_url">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestMisc.test_validate_file_url">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_validate_file_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for AlyxClient._validate_file_url.&quot;&quot;&quot;</span>
        <span class="c1"># Should assert that domain matches data server parameter</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">):</span>
            <span class="n">ac</span><span class="o">.</span><span class="n">_validate_file_url</span><span class="p">(</span><span class="s1">&#39;https://webserver.net/path/to/file&#39;</span><span class="p">)</span>
        <span class="c1"># Should check that the domain is equal and return same URL</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">HTTP_DATA_SERVER</span> <span class="o">+</span> <span class="s1">&#39;/path/to/file.ext&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">_validate_file_url</span><span class="p">(</span><span class="n">expected</span><span class="p">),</span> <span class="n">expected</span><span class="p">)</span>
        <span class="c1"># Should prepend data server URL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">_validate_file_url</span><span class="p">(</span><span class="s1">&#39;/path/to/file.ext&#39;</span><span class="p">),</span> <span class="n">expected</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestMisc.test_no_cache_context_manager">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestMisc.test_no_cache_context_manager">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_no_cache_context_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for one.webclient.no_cache function.&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">ac</span><span class="o">.</span><span class="n">cache_mode</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="n">wc</span><span class="o">.</span><span class="n">no_cache</span><span class="p">(</span><span class="n">ac</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">cache_mode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">cache_mode</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestMisc.test_cache_dir_setter">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestMisc.test_cache_dir_setter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_cache_dir_setter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tests setter for AlyxClient.cache_dir attribute.&quot;&quot;&quot;</span>
        <span class="n">prev_path</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">cache_dir</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ac</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">=</span> <span class="n">prev_path</span> <span class="o">/</span> <span class="s1">&#39;foobar&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">ac</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">CACHE_DIR</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">ac</span><span class="o">.</span><span class="n">_par</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;CACHE_DIR&#39;</span><span class="p">,</span> <span class="n">prev_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="TestMisc.test_paginated_response">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestMisc.test_paginated_response">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_paginated_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test the _PaginatedResponse class.&quot;&quot;&quot;</span>
        <span class="n">alyx</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">ac</span><span class="p">)</span>
        <span class="n">N</span><span class="p">,</span> <span class="n">lim</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">250</span>  <span class="c1"># 2000 results, 250 records per page</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">ac</span><span class="o">.</span><span class="n">base_url</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;/?foo=bar&amp;offset=</span><span class="si">{</span><span class="n">lim</span><span class="si">}</span><span class="s1">&amp;limit=</span><span class="si">{</span><span class="n">lim</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">N</span><span class="p">,</span> <span class="s1">&#39;next&#39;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="s1">&#39;previous&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">lim</span><span class="p">)]</span>
        <span class="n">alyx</span><span class="o">.</span><span class="n">_generic_request</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">res</span>
        <span class="c1"># Check initialization</span>
        <span class="n">pg</span> <span class="o">=</span> <span class="n">wc</span><span class="o">.</span><span class="n">_PaginatedResponse</span><span class="p">(</span><span class="n">alyx</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">cache_args</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pg</span><span class="p">),</span> <span class="n">N</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">limit</span><span class="p">,</span> <span class="n">lim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">_cache</span><span class="p">),</span> <span class="n">N</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">_cache</span><span class="p">[:</span><span class="n">lim</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">lim</span><span class="p">:]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">alyx</span><span class="p">,</span> <span class="n">alyx</span><span class="p">)</span>

        <span class="c1"># Check adding callbacks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">pg</span><span class="o">.</span><span class="n">add_callback</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">wf</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">Mock</span><span class="p">(</span><span class="n">spec_set</span><span class="o">=</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">)</span>
        <span class="n">cb1</span><span class="p">,</span> <span class="n">cb2</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">(),</span> <span class="n">wf</span><span class="p">()</span>
        <span class="n">pg</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">cb1</span><span class="p">)</span>
        <span class="n">pg</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">))</span>

        <span class="c1"># Check fetching cached item with +ve int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">pg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">alyx</span><span class="o">.</span><span class="n">_generic_request</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="p">[</span><span class="n">cb1</span><span class="p">,</span> <span class="n">cb2</span><span class="p">]:</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
        <span class="c1"># Check fetching cached item with +ve slice</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}],</span> <span class="n">pg</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">alyx</span><span class="o">.</span><span class="n">_generic_request</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="p">[</span><span class="n">cb1</span><span class="p">,</span> <span class="n">cb2</span><span class="p">]:</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
        <span class="c1"># Check fetching cached item with -ve int</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span> <span class="n">pg</span><span class="p">[</span><span class="o">-</span><span class="mi">1900</span><span class="p">])</span>
        <span class="n">alyx</span><span class="o">.</span><span class="n">_generic_request</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
        <span class="c1"># Check fetching cached item with -ve slice</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="mi">101</span><span class="p">}],</span> <span class="n">pg</span><span class="p">[</span><span class="o">-</span><span class="mi">1900</span><span class="p">:</span><span class="o">-</span><span class="mi">1898</span><span class="p">])</span>
        <span class="n">alyx</span><span class="o">.</span><span class="n">_generic_request</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
        <span class="c1"># Check fetching uncached item with +ve int</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">lim</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">lim</span><span class="p">)]</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">lim</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">lim</span><span class="p">},</span> <span class="n">pg</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">],</span> <span class="n">pg</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">lim</span><span class="p">])</span>
        <span class="n">alyx</span><span class="o">.</span><span class="n">_generic_request</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_get_query</span><span class="p">(</span><span class="n">alyx</span><span class="o">.</span><span class="n">_generic_request</span><span class="o">.</span><span class="n">call_args</span><span class="p">,</span> <span class="n">lim</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cb</span> <span class="ow">in</span> <span class="p">[</span><span class="n">cb1</span><span class="p">,</span> <span class="n">cb2</span><span class="p">]:</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">assert_called_once_with</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">])</span>
        <span class="c1"># Check that dead weakreaf will be removed from the list on next call</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Check fetching uncached item with -ve int</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">lim</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">lim</span><span class="p">)]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">lim</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">N</span> <span class="o">+</span> <span class="n">n</span><span class="p">},</span> <span class="n">pg</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">],</span> <span class="n">pg</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">lim</span><span class="p">])</span>
        <span class="n">alyx</span><span class="o">.</span><span class="n">_generic_request</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_get_query</span><span class="p">(</span><span class="n">alyx</span><span class="o">.</span><span class="n">_generic_request</span><span class="o">.</span><span class="n">call_args</span><span class="p">,</span> <span class="n">lim</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">),</span> <span class="s1">&#39;failed to remove weakref callback&#39;</span><span class="p">)</span>
        <span class="c1"># Check fetching uncached item with +ve slice</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">lim</span> <span class="o">*</span> <span class="mi">5</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">lim</span><span class="p">)]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="mi">20</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">lim</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">}],</span> <span class="n">pg</span><span class="p">[</span><span class="n">n</span> <span class="p">:</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">],</span> <span class="n">pg</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">lim</span><span class="p">])</span>
        <span class="n">alyx</span><span class="o">.</span><span class="n">_generic_request</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_get_query</span><span class="p">(</span><span class="n">alyx</span><span class="o">.</span><span class="n">_generic_request</span><span class="o">.</span><span class="n">call_args</span><span class="p">,</span> <span class="n">lim</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="c1"># Check fetching uncached item with -ve slice</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">N</span> <span class="o">-</span> <span class="n">lim</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">lim</span><span class="p">)]</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">lim</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}],</span> <span class="n">pg</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">],</span> <span class="n">pg</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">offset</span> <span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">lim</span><span class="p">])</span>
        <span class="n">alyx</span><span class="o">.</span><span class="n">_generic_request</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">mock</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_get_query</span><span class="p">(</span><span class="n">alyx</span><span class="o">.</span><span class="n">_generic_request</span><span class="o">.</span><span class="n">call_args</span><span class="p">,</span> <span class="n">lim</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="c1"># At this point, there should be a certain number of None values left</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected_calls</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">alyx</span><span class="o">.</span><span class="n">_generic_request</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="n">expected_calls</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">lim</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">pg</span><span class="o">.</span><span class="n">_cache</span><span class="p">))))</span>

        <span class="c1"># Check callbacks cleared when cache fully populated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">pg</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pg</span><span class="o">.</span><span class="n">_callbacks</span><span class="p">))</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_check_get_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">call_args</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">offset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check URL get query contains the expected limit and offset params.&quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">url</span><span class="p">),</span> <span class="n">_</span> <span class="o">=</span> <span class="n">call_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ac</span><span class="o">.</span><span class="n">base_url</span><span class="p">))</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">parse_qs</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;bar&#39;</span><span class="p">],</span> <span class="s1">&#39;offset&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">offset</span><span class="p">)],</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">limit</span><span class="p">)]}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertDictEqual</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

<div class="viewcode-block" id="TestMisc.test_json_encoder">
<a class="viewcode-back" href="../../../_autosummary/one.tests.test_alyxclient.html#one.tests.test_alyxclient.TestMisc.test_json_encoder">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_json_encoder</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test that the JSONEncoder subclass serializes UUID objects.&quot;&quot;&quot;</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
        <span class="c1"># Check encoder subclass behaviour for UUID objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">uid</span><span class="p">),</span> <span class="n">wc</span><span class="o">.</span><span class="n">_JSONEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">default</span><span class="p">(</span><span class="n">uid</span><span class="p">))</span>
        <span class="c1"># Encoder should still raise for other object types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">wc</span><span class="o">.</span><span class="n">_JSONEncoder</span><span class="p">()</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="c1"># Using json dumps</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;bar&#39;</span><span class="p">:</span> <span class="n">uid</span><span class="p">}</span>
        <span class="c1"># First check that the default encoder raises;</span>
        <span class="c1"># python could add support for UUID objects in the future</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="n">serialized</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">wc</span><span class="o">.</span><span class="n">_JSONEncoder</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;{&quot;foo&quot;: 12, &quot;bar&quot;: &quot;&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;}&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">serialized</span><span class="p">)</span></div>
</div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">(</span><span class="n">exit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, International Brain Lab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>