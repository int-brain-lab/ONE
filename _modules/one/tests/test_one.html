<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>one.tests.test_one &mdash; ONE  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/style.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ONE
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Using ONE to access data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../one_reference.html">Introduction to ONE (Open Neurophysiology Environment)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../one_installation.html">ONE installation and setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/one_quickstart.html">ONE Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/one_search/one_search.html">Searching with ONE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/one_list/one_list.html">Listing with ONE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/one_load/one_load.html">Loading with ONE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/experiment_ids.html">Experiment IDs</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using ONE with Alyx</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/one_modes.html">ONE API modes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/one_advanced/one_advanced.html">ONE REST queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/useful_alyx_queries.html">Useful Alyx REST queries</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Using ONE to share data</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/data_sharing.html">Releasing data with ONE</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/recording_data_access.html">Recording Data Access</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">ALF</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../alf_intro.html">ALyx Filenames (ALF)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/alyx_files.html">Listing Alyx Filenames</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../notebooks/datasets_and_types.html">Datasets and their types</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../FAQ.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing to documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../genindex.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ONE</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">one.tests.test_one</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for one.tests.test_one</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Unit tests for the one.api module</span>

<span class="sd">Wherever possible the ONE tests should not rely on an internet connection</span>

<span class="sd">Fixture locations:</span>

<span class="sd">- The cache tables for the public test instance are in tests/fixtures/</span>
<span class="sd">- The test db parameters can be found in tests/fixtures/params/</span>
<span class="sd">- Some REST GET requests can be found in tests/fixtures/rest_responses/</span>
<span class="sd">- These can be copied over to a temporary directory using the functions in tests/util.py,</span>
<span class="sd">  then construct ONE with the directory as cache_dir, mode=&#39;local&#39; and silent=True</span>

<span class="sd">Imported constants:</span>

<span class="sd">- For tests that do require a remote connection use the tests.OFFLINE_ONLY flag in the skipIf</span>
<span class="sd">  decorator.</span>
<span class="sd">- For testing REST POST requests use TEST_DB_1 (test.alyx.internationalbrainlab.org).</span>
<span class="sd">- For testing download functions, use TEST_DB_2 (openalyx.internationalbrainlab.org).</span>

<span class="sd">Note ONE and AlyxClient use caching:</span>

<span class="sd">- When verifying remote changes via the rest method, use the no_cache flag to ensure the remote</span>
<span class="sd">  databaseis queried.  You can clear the cache using AlyxClient.clear_rest_cache(),</span>
<span class="sd">  or mock iblutil.io.params.getfile to return a temporary cache directory</span>
<span class="sd">- An One object created through the one.api.ONE function, make sure you restore the</span>
<span class="sd">  properties to their original state on teardown, or call one.api.ONE.cache_clear()</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">permutations</span><span class="p">,</span> <span class="n">combinations_with_replacement</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">mock</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">uuid4</span>
<span class="kn">import</span> <span class="nn">io</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">requests.exceptions</span> <span class="kn">import</span> <span class="n">HTTPError</span>
<span class="kn">from</span> <span class="nn">iblutil.io</span> <span class="kn">import</span> <span class="n">parquet</span>
<span class="kn">from</span> <span class="nn">iblutil.util</span> <span class="kn">import</span> <span class="n">Bunch</span>

<span class="kn">from</span> <span class="nn">one</span> <span class="kn">import</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">one.api</span> <span class="kn">import</span> <span class="n">ONE</span><span class="p">,</span> <span class="n">One</span><span class="p">,</span> <span class="n">OneAlyx</span>
<span class="kn">from</span> <span class="nn">one.util</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ses2records</span><span class="p">,</span> <span class="n">validate_date_range</span><span class="p">,</span> <span class="n">index_last_before</span><span class="p">,</span> <span class="n">filter_datasets</span><span class="p">,</span> <span class="n">_collection_spec</span><span class="p">,</span>
    <span class="n">filter_revision_last_before</span><span class="p">,</span> <span class="n">parse_id</span><span class="p">,</span> <span class="n">autocomplete</span><span class="p">,</span> <span class="n">LazyId</span><span class="p">,</span> <span class="n">datasets2records</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">one.params</span>
<span class="kn">import</span> <span class="nn">one.alf.exceptions</span> <span class="k">as</span> <span class="nn">alferr</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">OFFLINE_ONLY</span><span class="p">,</span> <span class="n">TEST_DB_1</span><span class="p">,</span> <span class="n">TEST_DB_2</span>  <span class="c1"># 1 = TestAlyx; 2 = OpenAlyx</span>


<div class="viewcode-block" id="TestONECache"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache">[docs]</a><span class="k">class</span> <span class="nc">TestONECache</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test methods that use sessions and datasets tables.</span>
<span class="sd">    This class loads the parquet tables from the fixtures and builds a file tree in a temp folder</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tempdir</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="TestONECache.setUp"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">set_up_env</span><span class="p">()</span>
        <span class="c1"># Create ONE object with temp cache dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span> <span class="o">=</span> <span class="n">ONE</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># Create dset files from cache</span>
        <span class="n">util</span><span class="o">.</span><span class="n">create_file_tree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestONECache.tearDown"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">while</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.cache.lock&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">.1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestONECache.test_list_subjects"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_list_subjects">[docs]</a>    <span class="k">def</span> <span class="nf">test_list_subjects</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test One.list_subejcts&quot;&quot;&quot;</span>
        <span class="n">subjects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_subjects</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;KS005&#39;</span><span class="p">,</span> <span class="s1">&#39;ZFM-01935&#39;</span><span class="p">,</span> <span class="s1">&#39;ZM_1094&#39;</span><span class="p">,</span> <span class="s1">&#39;ZM_1150&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;ZM_1743&#39;</span><span class="p">,</span> <span class="s1">&#39;ZM_335&#39;</span><span class="p">,</span> <span class="s1">&#39;clns0730&#39;</span><span class="p">,</span> <span class="s1">&#39;flowers&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">subjects</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestONECache.test_offline_repr"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_offline_repr">[docs]</a>    <span class="k">def</span> <span class="nf">test_offline_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for One.offline property&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;offline&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestONECache.test_one_search"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_one_search">[docs]</a>    <span class="k">def</span> <span class="nf">test_one_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for One.search&quot;&quot;&quot;</span>
        <span class="n">one</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span>
        <span class="c1"># Search subject</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="s1">&#39;ZM_335&#39;</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;3473f9d2-aa5d-41a6-9048-c65d0b7ab97c&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;dfe99506-b873-45db-bc93-731f9362e304&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">eids</span><span class="p">)</span>

        <span class="c1"># Search lab</span>
        <span class="n">labs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mainen&#39;</span><span class="p">,</span> <span class="s1">&#39;cortexlab&#39;</span><span class="p">]</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">laboratory</span><span class="o">=</span><span class="n">labs</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;d3372b15-f696-4279-9be5-98f15783b5bb&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;3473f9d2-aa5d-41a6-9048-c65d0b7ab97c&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eids</span><span class="p">),</span> <span class="mi">25</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">eids</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Search exact date</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="s1">&#39;2019-06-07&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">eids</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;db524c42-6356-4c61-b236-4967c54d2665&#39;</span><span class="p">])</span>

        <span class="c1"># Search date range</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2019-04-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2019-04-10&#39;</span><span class="p">]</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;13c99443-01ee-462e-b668-717daa526fc0&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;abf5109c-d780-44c8-9561-83e857c7bc01&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eids</span><span class="p">),</span> <span class="mi">9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">eids</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Search from a given date</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2021-01-01&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">date_range</span><span class="o">=</span><span class="n">dates</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">eids</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;d3372b15-f696-4279-9be5-98f15783b5bb&#39;</span><span class="p">])</span>

        <span class="c1"># Search datasets</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;spikes.depths&#39;</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">eids</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;d3372b15-f696-4279-9be5-98f15783b5bb&#39;</span><span class="p">,</span>
            <span class="s1">&#39;b1c968ad-4874-468d-b2e4-5ffa9b9964e9&#39;</span><span class="p">,</span>
            <span class="s1">&#39;cf264653-2deb-44cb-aa84-89b82507028a&#39;</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">eids</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

        <span class="c1"># Filter non-existent</span>
        <span class="c1"># Set exist for one of the eids to false</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">][</span><span class="s1">&#39;rel_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s1">&#39;exists&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eids</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">query</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Search task_protocol</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="s1">&#39;habituation&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">eids</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;ac80cd12-49e5-4aff-b5f2-1a718679ceeb&#39;</span><span class="p">])</span>

        <span class="c1"># Search project</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">proj</span><span class="o">=</span><span class="s1">&#39;neuropix&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eids</span><span class="p">),</span> <span class="mi">20</span><span class="p">)</span>

        <span class="c1"># Search number</span>
        <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>

        <span class="n">sess_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">eids</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">sess_num</span> <span class="o">==</span> <span class="n">number</span><span class="p">))</span>

        <span class="n">number</span> <span class="o">=</span> <span class="s1">&#39;002&#39;</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">number</span><span class="p">)</span>

        <span class="n">sess_num</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">eids</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">sess_num</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">number</span><span class="p">)))</span>

        <span class="c1"># Empty results</span>
        <span class="n">eids</span><span class="p">,</span> <span class="n">det</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="s1">&#39;KS000&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
        <span class="c1"># Check works with just one search term</span>
        <span class="n">eids</span><span class="p">,</span> <span class="n">det</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>

        <span class="c1"># Test multiple fields, with short params</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">subj</span><span class="o">=</span><span class="s1">&#39;KS005&#39;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="s1">&#39;2019-04-10&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="s1">&#39;003&#39;</span><span class="p">,</span> <span class="n">lab</span><span class="o">=</span><span class="s1">&#39;cortexlab&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eids</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Test param error validation</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">dat</span><span class="o">=</span><span class="s1">&#39;2021-03-05&#39;</span><span class="p">)</span>  <span class="c1"># ambiguous</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s1">&#39;mister&#39;</span><span class="p">)</span>  <span class="c1"># invalid search term</span>

        <span class="c1"># Test details parameter</span>
        <span class="n">eids</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="s1">&#39;2019-04-10&#39;</span><span class="p">,</span> <span class="n">lab</span><span class="o">=</span><span class="s1">&#39;cortexlab&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">details</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">details</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="c1"># Test search with integer ids</span>
        <span class="n">util</span><span class="o">.</span><span class="n">caches_str2int</span><span class="p">(</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span>
        <span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;clusters&#39;</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">eids</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">eids</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestONECache.test_filter"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_filter">[docs]</a>    <span class="k">def</span> <span class="nf">test_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test one.util.filter_datasets&quot;&quot;&quot;</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Test identity</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">revision_last_before</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">verifiable</span><span class="p">))</span>

        <span class="c1"># Test collection filter</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;alf&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">revision_last_before</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">verifiable</span><span class="p">))</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFMultipleCollectionsFound</span><span class="p">):</span>
            <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;raw.*&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">revision_last_before</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Test filter empty collection</span>
        <span class="n">datasets</span><span class="o">.</span><span class="n">rel_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;_ibl_trials.rewardVolume.npy&#39;</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">revision_last_before</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">verifiable</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Test dataset filter</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="s1">&#39;_iblrig_.*&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">revision_last_before</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">verifiable</span><span class="p">))</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFMultipleObjectsFound</span><span class="p">):</span>
            <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="s1">&#39;_iblrig_.*&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_video_data&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">revision_last_before</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Test list as logical OR</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;alf/_ibl_wheel.*&#39;</span><span class="p">,</span> <span class="s1">&#39;_ibl_trials.*&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">revision_last_before</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_ibl_trials&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;alf/_ibl_wheel&#39;</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">verifiable</span><span class="o">.</span><span class="n">rel_path</span><span class="p">))</span>

        <span class="c1"># Test as dict</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;ibl&#39;</span><span class="p">,</span> <span class="nb">object</span><span class="o">=</span><span class="s1">&#39;trials&#39;</span><span class="p">)</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">revision_last_before</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">verifiable</span><span class="p">))</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">timescale</span><span class="o">=</span><span class="s1">&#39;bpod&#39;</span><span class="p">,</span> <span class="nb">object</span><span class="o">=</span><span class="s1">&#39;trials&#39;</span><span class="p">)</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">revision_last_before</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">verifiable</span><span class="p">[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;alf/_ibl_trials.intervals_bpod.npy&#39;</span><span class="p">)</span>

        <span class="c1"># As dict with list (should act as logical OR)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;time.+&#39;</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">])</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">revision_last_before</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">verifiable</span><span class="p">))</span>

        <span class="c1"># Revisions</span>
        <span class="n">revisions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;alf/probe00/#2020-01-01#/spikes.times.npy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;alf/probe00/#2020-08-31#/spikes.times.npy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;alf/probe00/spikes.times.npy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;alf/probe00/#2021-xx-xx#/spikes.times.npy&#39;</span><span class="p">,</span>
            <span class="s1">&#39;alf/probe01/#2020-01-01#/spikes.times.npy&#39;</span>
        <span class="p">]</span>
        <span class="n">datasets</span><span class="p">[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">revisions</span>

        <span class="c1"># Should return last revision before date for each collection/dataset</span>
        <span class="n">revision</span> <span class="o">=</span> <span class="s1">&#39;2020-09-06&#39;</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">revision</span><span class="p">,</span> <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">verifiable</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">revision</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">verifiable</span><span class="p">[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">]))</span>

        <span class="c1"># Should return single dataset with last revision when default specified</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFMultipleRevisionsFound</span><span class="p">):</span>
            <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="s1">&#39;*spikes.times*&#39;</span><span class="p">,</span> <span class="s1">&#39;alf/probe00&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">assert_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wildcards</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">revision_last_before</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Should return matching revision</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;2020-08-\d</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="p">,</span>
                                     <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">revision_last_before</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">verifiable</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">verifiable</span><span class="p">[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;#2020-08-31#&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="c1"># Matches more than one revision; should raise error</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFMultipleRevisionsFound</span><span class="p">):</span>
            <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;.*probe00&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;2020-0[18]-\d</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">revision_last_before</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Should return revision that&#39;s lexicographically first for each dataset</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">verifiable</span><span class="p">))</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">verifiable</span><span class="p">[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">((</span><span class="s1">&#39;2021-xx-xx&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-01-01&#39;</span><span class="p">),</span> <span class="n">actual</span><span class="p">)</span>

        <span class="c1"># Should return those without revision</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">verifiable</span><span class="p">[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">())</span>

        <span class="c1"># Should return empty</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;.*01&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">verifiable</span><span class="p">))</span>

        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;.*01&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">verifiable</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">verifiable</span><span class="p">[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;#2020-01-01#&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="c1"># Should return dataset marked as default</span>
        <span class="n">datasets</span><span class="p">[</span><span class="s1">&#39;default_revision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">revisions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">verifiable</span><span class="o">.</span><span class="n">rel_path</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># Load dataset with default revision</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="s1">&#39;*spikes.times*&#39;</span><span class="p">,</span> <span class="s1">&#39;alf/probe00&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">assert_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wildcards</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">revision_last_before</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">verifiable</span><span class="o">.</span><span class="n">rel_path</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
                         <span class="p">[</span><span class="s1">&#39;alf/probe00/#2020-01-01#/spikes.times.npy&#39;</span><span class="p">])</span>
        <span class="c1"># When revision_last_before is false, expect multiple objects error</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFMultipleObjectsFound</span><span class="p">):</span>
            <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="s1">&#39;*spikes.times*&#39;</span><span class="p">,</span> <span class="s1">&#39;alf/probe00&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">assert_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">wildcards</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">revision_last_before</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestONECache.test_filter_wildcards"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_filter_wildcards">[docs]</a>    <span class="k">def</span> <span class="nf">test_filter_wildcards</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test one.util.filter_datasets with wildcards flag set to True&quot;&quot;&quot;</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Test identity</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="s1">&#39;_ibl_*&#39;</span><span class="p">,</span> <span class="s1">&#39;*lf&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">wildcards</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">verifiable</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># As dict with list (should act as logical OR)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;timestamp?&#39;</span><span class="p">,</span> <span class="s1">&#39;raw&#39;</span><span class="p">])</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_datasets</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                     <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">revision_last_before</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">wildcards</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">verifiable</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestONECache.test_list_datasets"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_list_datasets">[docs]</a>    <span class="k">def</span> <span class="nf">test_list_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test One.list_datasets&quot;&quot;&quot;</span>
        <span class="c1"># test filename</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;_ibl_trials*&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">),</span> <span class="mi">18</span><span class="p">)</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s1">&#39;gnagnag&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Test no eid</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">dsets</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="p">)</span>

        <span class="c1"># Test list for eid</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="s1">&#39;KS005/2019-04-02/001&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">27</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">))</span>

        <span class="c1"># Test filters</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;attribute&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">,</span> <span class="s1">&#39;intervals&#39;</span><span class="p">],</span> <span class="s1">&#39;extension&#39;</span><span class="p">:</span> <span class="s1">&#39;npy&#39;</span><span class="p">}</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="s1">&#39;ZFM-01935/2021-02-05/001&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">y</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;.times.&#39;</span><span class="p">,</span> <span class="s1">&#39;.intervals&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dsets</span><span class="p">))</span>

        <span class="n">filename</span><span class="p">[</span><span class="s1">&#39;attribute&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;*&#39;</span>  <span class="c1"># Include wildcard to match both times and timestamps</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="s1">&#39;ZFM-01935/2021-02-05/001&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="s1">&#39;.timestamps.&#39;</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dsets</span><span class="p">))</span>

        <span class="c1"># Test using str ids as index</span>
        <span class="n">util</span><span class="o">.</span><span class="n">caches_str2int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="s1">&#39;KS005/2019-04-02/001&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">27</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">))</span>

        <span class="c1"># Test empty</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="s1">&#39;FMR019/2021-03-18/002&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Test details=False, with and without eid</span>
        <span class="k">for</span> <span class="n">eid</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;KS005/2019-04-02/001&#39;</span><span class="p">]:</span>
            <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dsets</span><span class="p">)</span><span class="o">.</span><span class="n">size</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestONECache.test_list_collections"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_list_collections">[docs]</a>    <span class="k">def</span> <span class="nf">test_list_collections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test One.list_collections&quot;&quot;&quot;</span>
        <span class="c1"># Test no eid</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_collections</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;alf&#39;</span><span class="p">,</span> <span class="s1">&#39;alf/ks2&#39;</span><span class="p">,</span> <span class="s1">&#39;alf/probe00&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_behavior_data&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_ephys_data&#39;</span><span class="p">,</span>
            <span class="s1">&#39;raw_ephys_data/probe00&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_passive_data&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_video_data&#39;</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">dsets</span><span class="p">)</span>

        <span class="c1"># Test details for eid</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_collections</span><span class="p">(</span><span class="s1">&#39;KS005/2019-04-02/001&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">expected</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="s1">&#39;alf&#39;</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="s1">&#39;alf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rel_path</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;alf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="c1"># Test empty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_collections</span><span class="p">(</span><span class="s1">&#39;FMR019/2021-03-18/002&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_collections</span><span class="p">(</span><span class="s1">&#39;FMR019/2021-03-18/002&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span></div>

<div class="viewcode-block" id="TestONECache.test_list_revisions"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_list_revisions">[docs]</a>    <span class="k">def</span> <span class="nf">test_list_revisions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test One.list_revisions&quot;&quot;&quot;</span>
        <span class="c1"># No revisions in cache fixture so generate our own</span>
        <span class="n">revisions_datasets</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">revisions_datasets_table</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="p">,</span> <span class="n">revisions_datasets</span><span class="p">])</span>
        <span class="n">eid</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">revisions_datasets</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Test no eid</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_revisions</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-01-08&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-07-06&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">dsets</span><span class="p">)</span>

        <span class="c1"># Test details for eid</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_revisions</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">expected</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="s1">&#39;2020-01-08&#39;</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="s1">&#39;2020-01-08&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rel_path</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;#2020-01-08#&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="c1"># Test dataset filter</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_revisions</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;spikes.times.npy&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="s1">&#39;2020-01-08&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rel_path</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;spikes.times.npy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="c1"># Test collections filter</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_revisions</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="s1">&#39;alf/probe01&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="s1">&#39;2020-01-08&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">rel_path</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;alf/probe01&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="c1"># Test revision filter</span>
        <span class="n">revisions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_revisions</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;202[01]*&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">([</span><span class="s1">&#39;2020-01-08&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-07-06&#39;</span><span class="p">],</span> <span class="n">revisions</span><span class="p">)</span>

        <span class="c1"># Test empty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_revisions</span><span class="p">(</span><span class="s1">&#39;FMR019/2021-03-18/002&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_revisions</span><span class="p">(</span><span class="s1">&#39;FMR019/2021-03-18/002&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span></div>

<div class="viewcode-block" id="TestONECache.test_get_details"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_get_details">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test One.get_details&quot;&quot;&quot;</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="s1">&#39;aaf101c3-2581-450a-8abd-ddb8f557a5ad&#39;</span>
        <span class="n">det</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">get_details</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;KS005&#39;</span><span class="p">,</span> <span class="n">det</span><span class="o">.</span><span class="n">subject</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;2019-04-04&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">det</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">det</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>

        <span class="c1"># Test details flag</span>
        <span class="n">det</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">get_details</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;rel_path&#39;</span> <span class="ow">in</span> <span class="n">det</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="c1"># Test with int index ids</span>
        <span class="n">util</span><span class="o">.</span><span class="n">caches_str2int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span>
        <span class="n">det</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">get_details</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>

        <span class="c1"># Test errors</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFObjectNotFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">get_details</span><span class="p">(</span><span class="n">eid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">))</span>
        <span class="n">sessions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">sessions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">sessions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">sessions</span><span class="p">,</span> <span class="n">det</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFMultipleObjectsFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">get_details</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestONECache.test_index_type"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_index_type">[docs]</a>    <span class="k">def</span> <span class="nf">test_index_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test One._index_type&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_index_type</span><span class="p">())</span>
        <span class="n">util</span><span class="o">.</span><span class="n">caches_str2int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_index_type</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IndexError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_index_type</span><span class="p">(</span><span class="s1">&#39;datasets&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestONECache.test_load_dataset"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_load_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test One.load_dataset&quot;&quot;&quot;</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="s1">&#39;KS005/2019-04-02/001&#39;</span>
        <span class="c1"># Check download only</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;_ibl_wheel.position.npy&#39;</span><span class="p">,</span> <span class="n">download_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span>

        <span class="c1"># Check loading data</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>  <span class="c1"># Make sure we have something to load</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;_ibl_wheel.position.npy&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">dset</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>

        <span class="c1"># Check collection filter</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;_iblrig_leftCamera.timestamps.ssv&#39;</span><span class="p">,</span>
                                     <span class="n">download_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="s1">&#39;raw_video_data&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="c1"># Test errors</span>
        <span class="c1"># ID not in cache</span>
        <span class="n">fake_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">to_eid</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFObjectNotFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">fake_id</span><span class="p">,</span> <span class="s1">&#39;_iblrig_leftCamera.timestamps.ssv&#39;</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFObjectNotFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;_iblrig_leftCamera.timestamps.ssv&#39;</span><span class="p">)</span>

        <span class="c1"># Check loading without extension</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;_ibl_wheel.position&#39;</span><span class="p">,</span> <span class="n">download_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;wheel.position.npy&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestONECache.test_load_datasets"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_load_datasets">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test One.load_datasets&quot;&quot;&quot;</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="s1">&#39;KS005/2019-04-02/001&#39;</span>
        <span class="c1"># Check download only</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_ibl_wheel.position.npy&#39;</span><span class="p">,</span> <span class="s1">&#39;_ibl_wheel.timestamps.npy&#39;</span><span class="p">]</span>
        <span class="n">files</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">dsets</span><span class="p">,</span> <span class="n">download_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">assert_present</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">))</span>

        <span class="c1"># Check loading data and missing dataset</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_ibl_wheel.position.npy&#39;</span><span class="p">,</span> <span class="s1">&#39;_ibl_wheel.timestamps_bpod.npy&#39;</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>  <span class="c1"># Make sure we have something to load</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">dsets</span><span class="p">,</span> <span class="n">download_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">assert_present</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>

        <span class="c1"># Check assert_present raises error</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFObjectNotFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">dsets</span><span class="p">,</span> <span class="n">assert_present</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check collection and revision filters</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_ibl_wheel.position.npy&#39;</span><span class="p">,</span> <span class="s1">&#39;_ibl_wheel.timestamps.npy&#39;</span><span class="p">]</span>
        <span class="n">files</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">dsets</span><span class="p">,</span> <span class="n">collections</span><span class="o">=</span><span class="s1">&#39;alf&#39;</span><span class="p">,</span> <span class="n">revisions</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                                             <span class="n">download_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">assert_present</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>

        <span class="n">files</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">dsets</span><span class="p">,</span> <span class="n">collections</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alf&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">],</span>
                                             <span class="n">download_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">assert_present</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Check validations</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">dsets</span><span class="p">,</span> <span class="n">collections</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alf&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;foo&#39;</span><span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;spikes.times&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFObjectNotFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="s1">&#39;ff812ca5-ce60-44ac-b07e-66c2c37e98eb&#39;</span><span class="p">,</span> <span class="n">dsets</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;one.api&#39;</span><span class="p">),</span> <span class="s1">&#39;WARNING&#39;</span><span class="p">):</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="s1">&#39;ff812ca5-ce60-44ac-b07e-66c2c37e98eb&#39;</span><span class="p">,</span> <span class="n">dsets</span><span class="p">,</span>
                                                <span class="n">assert_present</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">meta</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="p">[])[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFObjectNotFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">dsets</span><span class="p">,</span> <span class="n">collections</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">assert_present</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check behaviour when data are not downloaded for any reason</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">,</span> <span class="s1">&#39;_check_filesystem&#39;</span><span class="p">,</span>
                               <span class="n">side_effect</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;one.api&#39;</span><span class="p">),</span> <span class="s1">&#39;WARNING&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">dsets</span><span class="p">,</span> <span class="n">collections</span><span class="o">=</span><span class="s1">&#39;alf&#39;</span><span class="p">,</span> <span class="n">assert_present</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFObjectNotFound</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">dsets</span><span class="p">,</span> <span class="n">collections</span><span class="o">=</span><span class="s1">&#39;alf&#39;</span><span class="p">,</span> <span class="n">assert_present</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check loading without extensions</span>
        <span class="c1"># Check download only</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_ibl_wheel.position.npy&#39;</span><span class="p">,</span> <span class="s1">&#39;_ibl_wheel.timestamps&#39;</span><span class="p">]</span>
        <span class="n">files</span><span class="p">,</span> <span class="n">meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">dsets</span><span class="p">,</span> <span class="n">download_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestONECache.test_load_dataset_from_id"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_load_dataset_from_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_dataset_from_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test One.load_dataset_from_id&quot;&quot;&quot;</span>
        <span class="nb">id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">9204203870374650458</span><span class="p">,</span> <span class="o">-</span><span class="mi">6411285612086772563</span><span class="p">]])</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset_from_id</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">download_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;ZFM-01935/2021-02-05/001/alf/probe00/_phy_spikes_subset.waveforms.npy&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">expected</span><span class="p">))</span>

        <span class="c1"># Details</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset_from_id</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">download_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">details</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>

        <span class="c1"># Load file content with str id</span>
        <span class="n">s_id</span><span class="p">,</span> <span class="o">=</span> <span class="n">parquet</span><span class="o">.</span><span class="n">np2str</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="n">data</span><span class="p">)</span>  <span class="c1"># Ensure data to load</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset_from_id</span><span class="p">(</span><span class="n">s_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

        <span class="c1"># Load file content with UUID</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset_from_id</span><span class="p">(</span><span class="n">UUID</span><span class="p">(</span><span class="n">s_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

        <span class="c1"># Load with int ids as index</span>
        <span class="n">util</span><span class="o">.</span><span class="n">caches_str2int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset_from_id</span><span class="p">(</span><span class="n">s_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">dset</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

        <span class="c1"># Test errors</span>
        <span class="c1"># ID not in cache</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFObjectNotFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset_from_id</span><span class="p">(</span><span class="n">s_id</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">))</span>
        <span class="c1"># File missing</span>
        <span class="n">file</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFObjectNotFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset_from_id</span><span class="p">(</span><span class="n">s_id</span><span class="p">)</span>
        <span class="c1"># Duplicate ids in cache</span>
        <span class="n">details</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8737712210713458643</span><span class="p">,</span> <span class="o">-</span><span class="mi">4920882604093676133</span><span class="p">,</span> <span class="o">*</span><span class="nb">id</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">datasets</span><span class="p">,</span> <span class="n">details</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFMultipleObjectsFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset_from_id</span><span class="p">(</span><span class="n">s_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestONECache.test_load_object"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_load_object">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test One.load_object&quot;&quot;&quot;</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="s1">&#39;aaf101c3-2581-450a-8abd-ddb8f557a5ad&#39;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;wheel&#39;</span><span class="p">,</span> <span class="n">download_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">))</span>

        <span class="c1"># Save some data into the files</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># length of data</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
        <span class="n">wheel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;wheel&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">wheel</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">wheel</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="s1">&#39;velocity&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamps&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="nb">all</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">N</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">wheel</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="p">)</span>

        <span class="c1"># Test errors</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFObjectNotFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;spikes&#39;</span><span class="p">)</span>
        <span class="c1"># Test behaviour with missing session</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFObjectNotFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">eid</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">),</span> <span class="s1">&#39;wheel&#39;</span><span class="p">)</span>
        <span class="c1"># Test missing files on disk</span>
        <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFObjectNotFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;wheel&#39;</span><span class="p">)</span>
        <span class="c1"># Check the three wheel datasets set to exist = False in cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">eid</span><span class="p">,),</span> <span class="s1">&#39;exists&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="n">eid</span> <span class="o">=</span> <span class="s1">&#39;ZFM-01935/2021-02-05/001&#39;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFMultipleCollectionsFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;ephysData_g0_t0&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFMultipleObjectsFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;*Camera&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestONECache.test_load_collection"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_load_collection">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test One.load_collection&quot;&quot;&quot;</span>
        <span class="c1"># Check download_only output</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="s1">&#39;aaf101c3-2581-450a-8abd-ddb8f557a5ad&#39;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_collection</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;alf&#39;</span><span class="p">,</span> <span class="n">download_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="mi">18</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">))</span>
        <span class="c1"># Check load</span>
        <span class="n">alf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_collection</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;alf&#39;</span><span class="p">,</span> <span class="n">attribute</span><span class="o">=</span><span class="s1">&#39;*time*&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">alf</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="p">(</span><span class="s1">&#39;trials&#39;</span><span class="p">,</span> <span class="s1">&#39;wheel&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">alf</span><span class="p">,</span> <span class="n">Bunch</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;feedback_times&#39;</span><span class="p">,</span> <span class="n">alf</span><span class="o">.</span><span class="n">trials</span><span class="p">)</span>
        <span class="c1"># Check object filter</span>
        <span class="n">alf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_collection</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;alf&#39;</span><span class="p">,</span> <span class="nb">object</span><span class="o">=</span><span class="s1">&#39;trials&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;wheel&#39;</span><span class="p">,</span> <span class="n">alf</span><span class="p">)</span>
        <span class="c1"># Check errors</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_collection</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFObjectNotFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_collection</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;alf&#39;</span><span class="p">,</span> <span class="nb">object</span><span class="o">=</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
        <span class="c1"># Should raise error when no objects found on disk</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">,</span> <span class="s1">&#39;_check_filesystem&#39;</span><span class="p">,</span>
                               <span class="n">side_effect</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFObjectNotFound</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_collection</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;alf&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;not found on disk&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestONECache.test_load_cache"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_load_cache">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test One._load_cache&quot;&quot;&quot;</span>
        <span class="c1"># Test loading unsorted table with no id index set</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;_meta&#39;</span><span class="p">][</span><span class="s1">&#39;raw&#39;</span><span class="p">][</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tdir</span><span class="p">:</span>
            <span class="c1"># Loading from empty dir</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_cache</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;_meta&#39;</span><span class="p">][</span><span class="s1">&#39;expired&#39;</span><span class="p">])</span>
            <span class="c1"># Save unindexed</span>
            <span class="n">parquet</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;datasets.pqt&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_cache</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">)</span>
            <span class="c1"># Save shuffled</span>
            <span class="n">id_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;eid&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="n">id_keys</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">id_keys</span><span class="p">])</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">id_keys</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_monotonic_increasing</span>
            <span class="n">parquet</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;datasets.pqt&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_cache</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_monotonic_increasing</span><span class="p">)</span>
            <span class="c1"># Save a parasitic table that will not be loaded</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;gnagna.pqt&#39;</span><span class="p">))</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;one.api&#39;</span><span class="p">),</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span> <span class="k">as</span> <span class="n">log</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_cache</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;gnagna.pqt&#39;</span><span class="p">,</span> <span class="n">log</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># Save table with missing id columns</span>
            <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">id_keys</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">parquet</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span> <span class="o">/</span> <span class="s1">&#39;datasets.pqt&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_cache</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestONECache.test_refresh_cache"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_refresh_cache">[docs]</a>    <span class="k">def</span> <span class="nf">test_refresh_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test One.refresh_cache&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">prev_loaded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;_meta&#39;</span><span class="p">][</span><span class="s1">&#39;loaded_time&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span> <span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="s1">&#39;remote&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="s2">&quot;Refresh modes&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">):</span>
                <span class="n">loaded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">refresh_cache</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">prev_loaded</span><span class="p">,</span> <span class="n">loaded</span><span class="p">)</span>
        <span class="n">loaded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">refresh_cache</span><span class="p">(</span><span class="s1">&#39;refresh&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">loaded</span> <span class="o">&gt;</span> <span class="n">prev_loaded</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">cache_expiry</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">()</span>  <span class="c1"># Immediately expire</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">refresh_cache</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="p">))</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">refresh_cache</span><span class="p">(</span><span class="s1">&#39;double&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestONECache.test_save_cache"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_save_cache">[docs]</a>    <span class="k">def</span> <span class="nf">test_save_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test one.util.save_cache&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;_meta&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;modified_time&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Should be no cache save as it&#39;s not been modified</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tdir</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_save_cache</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">tdir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)))</span>
            <span class="c1"># Should save two tables</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;_meta&#39;</span><span class="p">][</span><span class="s1">&#39;modified_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_save_cache</span><span class="p">(</span><span class="n">save_dir</span><span class="o">=</span><span class="n">tdir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">tdir</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.pqt&#39;</span><span class="p">))))</span>
            <span class="c1"># Load with One and check modified time is preserved</span>
            <span class="n">raw_modified</span> <span class="o">=</span> <span class="n">One</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">=</span><span class="n">tdir</span><span class="p">)</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;_meta&#39;</span><span class="p">][</span><span class="s1">&#39;raw&#39;</span><span class="p">][</span><span class="s1">&#39;datasets&#39;</span><span class="p">][</span><span class="s1">&#39;date_modified&#39;</span><span class="p">]</span>
            <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;_meta&#39;</span><span class="p">][</span><span class="s1">&#39;modified_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">raw_modified</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestONECache.test_update_cache_from_records"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_update_cache_from_records">[docs]</a>    <span class="k">def</span> <span class="nf">test_update_cache_from_records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test One._update_cache_from_records&quot;&quot;&quot;</span>
        <span class="c1"># Update with single record (pandas.Series), one exists, one doesn&#39;t</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">())</span>  <span class="c1"># New record</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;exists&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;exists&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_update_cache_from_records</span><span class="p">(</span><span class="n">sessions</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">datasets</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">sessions</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">updated</span><span class="p">,</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s1">&#39;exists&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataset</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;exists&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">updated</span><span class="p">)</span>

        <span class="c1"># Update a number of records</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;exists&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;exists&#39;</span><span class="p">]</span>
        <span class="c1"># Make one of the datasets a new record</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()))</span>
        <span class="n">datasets</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_update_cache_from_records</span><span class="p">(</span><span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">datasets</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s1">&#39;exists&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">verifiable</span> <span class="o">==</span> <span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;exists&#39;</span><span class="p">]))</span>

        <span class="c1"># Check behaviour when columns don&#39;t match</span>
        <span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;exists&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;exists&#39;</span><span class="p">]</span>
        <span class="n">datasets</span><span class="p">[</span><span class="s1">&#39;extra_column&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="p">[</span><span class="s1">&#39;new_column&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">drop</span><span class="p">,</span> <span class="s1">&#39;new_column&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_update_cache_from_records</span><span class="p">(</span><span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_update_cache_from_records</span><span class="p">(</span><span class="n">datasets</span><span class="o">=</span><span class="n">datasets</span><span class="p">)</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">datasets</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s1">&#39;exists&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">verifiable</span> <span class="o">==</span> <span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;exists&#39;</span><span class="p">]))</span>

        <span class="c1"># Check fringe cases</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_update_cache_from_records</span><span class="p">(</span><span class="n">unknown</span><span class="o">=</span><span class="n">datasets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_update_cache_from_records</span><span class="p">(</span><span class="n">datasets</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestONECache.test_save_loaded_ids"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestONECache.test_save_loaded_ids">[docs]</a>    <span class="k">def</span> <span class="nf">test_save_loaded_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test One.save_loaded_ids and logic within One._check_filesystem&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">record_loaded</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Turn on saving UUIDs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_loaded_datasets&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># Ensure we start with a clean slate</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="s1">&#39;d3372b15-f696-4279-9be5-98f15783b5bb&#39;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;trials&#39;</span><span class="p">,</span> <span class="n">download_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Check datasets added to list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;_loaded_datasets&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span>
        <span class="n">loaded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;_loaded_datasets&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">loaded</span><span class="p">))</span>
        <span class="c1"># Ensure all are from the same session</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">loaded</span><span class="p">),</span> <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_level_values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">eids</span> <span class="o">==</span> <span class="n">eid</span><span class="p">))</span>

        <span class="c1"># Test loading a dataset that doesn&#39;t exist</span>
        <span class="n">dset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;*trials*&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dset</span><span class="p">[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.npy&#39;</span><span class="p">,</span> <span class="s1">&#39;.pqt&#39;</span><span class="p">)</span>
        <span class="n">dset</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid4</span><span class="p">()))</span>
        <span class="n">old_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dset</span><span class="p">)</span>
            <span class="n">dsets</span> <span class="o">=</span> <span class="p">[</span><span class="n">dset</span><span class="p">[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">],</span> <span class="s1">&#39;_ibl_trials.feedback_times.npy&#39;</span><span class="p">]</span>
            <span class="n">new_files</span><span class="p">,</span> <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">dsets</span><span class="p">,</span> <span class="n">assert_present</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">loaded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;_loaded_datasets&#39;</span><span class="p">]</span>
            <span class="c1"># One dataset is already in the list (test for duplicates) and other doesn&#39;t exist</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">loaded</span><span class="p">),</span> <span class="s1">&#39;No new UUIDs should have been added&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">loaded</span><span class="p">)</span>  <span class="c1"># Already in list</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">loaded</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">loaded</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="n">dset</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">loaded</span><span class="p">)</span>  <span class="c1"># Wasn&#39;t loaded as doesn&#39;t exist on disk</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_cache</span>

        <span class="c1"># Test saving the loaded datasets list</span>
        <span class="n">ids</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">save_loaded_ids</span><span class="p">(</span><span class="n">clear_list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">loaded</span> <span class="ow">is</span> <span class="n">ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">filename</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
        <span class="c1"># Load from file</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">ids</span><span class="p">[</span><span class="s1">&#39;dataset_uuid&#39;</span><span class="p">],</span> <span class="n">loaded</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;_loaded_datasets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s1">&#39;List unexpectedly cleared&#39;</span><span class="p">)</span>

        <span class="c1"># Test as session UUIDs</span>
        <span class="n">ids</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">save_loaded_ids</span><span class="p">(</span><span class="n">sessions_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">clear_list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">([</span><span class="n">eid</span><span class="p">],</span> <span class="n">ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="s1">&#39;session_uuid&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">eid</span><span class="p">)</span>

        <span class="c1"># Test int IDs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;_loaded_datasets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parquet</span><span class="o">.</span><span class="n">str2np</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;_loaded_datasets&#39;</span><span class="p">])</span>
        <span class="c1"># IDs should be cast to string</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">save_loaded_ids</span><span class="p">(</span><span class="n">clear_list</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sessions_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Check dataset int IDs and clear list</span>
        <span class="n">ids</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">save_loaded_ids</span><span class="p">(</span><span class="n">clear_list</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">loaded</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;_loaded_datasets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s1">&#39;List not cleared&#39;</span><span class="p">)</span>

        <span class="c1"># Test clear list and warn on empty</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertWarns</span><span class="p">(</span><span class="ne">Warning</span><span class="p">):</span>
            <span class="n">ids</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">save_loaded_ids</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestOneAlyx"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneAlyx">[docs]</a><span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="n">OFFLINE_ONLY</span><span class="p">,</span> <span class="s1">&#39;online only test&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestOneAlyx</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This could be an offline test.  Would need to add /docs REST cache fixture.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tempdir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">one</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="TestOneAlyx.setUpClass"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneAlyx.setUpClass">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">tempdir</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">set_up_env</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.params.iopar.getfile&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">get_file</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">)):</span>
            <span class="c1"># util.setup_test_params(token=True)</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">one</span> <span class="o">=</span> <span class="n">OneAlyx</span><span class="p">(</span>
                <span class="o">**</span><span class="n">TEST_DB_1</span><span class="p">,</span>
                <span class="n">cache_dir</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;local&#39;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="TestOneAlyx.tearDown"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneAlyx.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;local&#39;</span></div>

<div class="viewcode-block" id="TestOneAlyx.test_type2datasets"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneAlyx.test_type2datasets">[docs]</a>    <span class="k">def</span> <span class="nf">test_type2datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test OneAlyx.type2datasets&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;remote&#39;</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="s1">&#39;cf264653-2deb-44cb-aa84-89b82507028a&#39;</span>
        <span class="c1"># when the dataset is at the root, there shouldn&#39;t be the separator</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">type2datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;eye.blink&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;eye.blink.npy&#39;</span><span class="p">])</span>
        <span class="c1"># test multiples datasets with collections</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="s1">&#39;8dd0fcb0-1151-4c97-ae35-2e2421695ad7&#39;</span>
        <span class="n">dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;trials.feedback_times&#39;</span><span class="p">,</span> <span class="s1">&#39;_iblrig_codeFiles.raw&#39;</span><span class="p">]</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">type2datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;alf/_ibl_trials.feedback_times.npy&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;raw_behavior_data/_iblrig_codeFiles.raw.zip&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
        <span class="c1"># this returns a DataFrame</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">type2datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="c1"># check validation</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">type2datasets</span><span class="p">(</span><span class="n">eid</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneAlyx.test_dataset2type"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneAlyx.test_dataset2type">[docs]</a>    <span class="k">def</span> <span class="nf">test_dataset2type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for OneAlyx.dataset2type&quot;&quot;&quot;</span>
        <span class="c1"># Test dataset ID</span>
        <span class="n">did</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">1058666951852871669</span><span class="p">,</span> <span class="o">-</span><span class="mi">6012002505064768322</span><span class="p">]])</span>

        <span class="c1"># Check assertion in local mode</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AssertionError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">dataset2type</span><span class="p">(</span><span class="n">did</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;remote&#39;</span>
        <span class="n">dset_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">dataset2type</span><span class="p">(</span><span class="n">did</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;wheelMoves.peakAmplitude&#39;</span><span class="p">,</span> <span class="n">dset_type</span><span class="p">)</span>
        <span class="c1"># Check with tuple int</span>
        <span class="n">dset_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">dataset2type</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">did</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;wheelMoves.peakAmplitude&#39;</span><span class="p">,</span> <span class="n">dset_type</span><span class="p">)</span>
        <span class="c1"># Check with str id</span>
        <span class="n">did</span><span class="p">,</span> <span class="o">=</span> <span class="n">parquet</span><span class="o">.</span><span class="n">np2str</span><span class="p">(</span><span class="n">did</span><span class="p">)</span>
        <span class="n">dset_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">dataset2type</span><span class="p">(</span><span class="n">did</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;wheelMoves.peakAmplitude&#39;</span><span class="p">,</span> <span class="n">dset_type</span><span class="p">)</span>

        <span class="n">dset_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">dataset2type</span><span class="p">(</span><span class="s1">&#39;_ibl_wheelMoves.peakAmplitude.npy&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;wheelMoves.peakAmplitude&#39;</span><span class="p">,</span> <span class="n">dset_type</span><span class="p">)</span>

        <span class="n">bad_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">1058666951852871669</span><span class="p">,</span> <span class="o">-</span><span class="mi">6012002505064768312</span><span class="p">]])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">dataset2type</span><span class="p">(</span><span class="n">bad_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneAlyx.test_ses2records"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneAlyx.test_ses2records">[docs]</a>    <span class="k">def</span> <span class="nf">test_ses2records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test one.util.ses2records&quot;&quot;&quot;</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="s1">&#39;8dd0fcb0-1151-4c97-ae35-2e2421695ad7&#39;</span>
        <span class="n">ses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;sessions&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">eid</span><span class="p">)</span>
        <span class="n">session</span><span class="p">,</span> <span class="n">datasets</span> <span class="o">=</span> <span class="n">ses2records</span><span class="p">(</span><span class="n">ses</span><span class="p">)</span>

        <span class="c1"># Verify returned tables are compatible with cache tables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">eid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;sessions&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ses</span><span class="p">[</span><span class="s1">&#39;data_dataset_session_related&#39;</span><span class="p">]))</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;default_revision&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">datasets</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">datasets</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;eid&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">datasets</span><span class="o">.</span><span class="n">default_revision</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="c1"># Check int_id as True</span>
        <span class="n">session</span><span class="p">,</span> <span class="n">datasets</span> <span class="o">=</span> <span class="n">ses2records</span><span class="p">(</span><span class="n">ses</span><span class="p">,</span> <span class="n">int_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">7544566139326771059</span><span class="p">,</span> <span class="o">-</span><span class="mi">2928913016589240914</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">datasets</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;eid_0&#39;</span><span class="p">,</span> <span class="s1">&#39;eid_1&#39;</span><span class="p">,</span> <span class="s1">&#39;id_0&#39;</span><span class="p">,</span> <span class="s1">&#39;id_1&#39;</span><span class="p">))</span>

        <span class="c1"># Check behaviour when no datasets present</span>
        <span class="n">ses</span><span class="p">[</span><span class="s1">&#39;data_dataset_session_related&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">datasets</span> <span class="o">=</span> <span class="n">ses2records</span><span class="p">(</span><span class="n">ses</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">datasets</span><span class="o">.</span><span class="n">empty</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneAlyx.test_datasets2records"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneAlyx.test_datasets2records">[docs]</a>    <span class="k">def</span> <span class="nf">test_datasets2records</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test one.util.datasets2records&quot;&quot;&quot;</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="s1">&#39;8dd0fcb0-1151-4c97-ae35-2e2421695ad7&#39;</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;datasets&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">eid</span><span class="p">)</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets2records</span><span class="p">(</span><span class="n">dsets</span><span class="p">)</span>

        <span class="c1"># Verify returned tables are compatible with cache tables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">))</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">datasets</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="s1">&#39;default_revision&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">datasets</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;eid&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">))</span>

        <span class="c1"># Check behaviour when ind_id is True</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets2records</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="n">int_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">datasets</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;eid_0&#39;</span><span class="p">,</span> <span class="s1">&#39;eid_1&#39;</span><span class="p">,</span> <span class="s1">&#39;id_0&#39;</span><span class="p">,</span> <span class="s1">&#39;id_1&#39;</span><span class="p">))</span>

        <span class="c1"># Test single input</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">datasets2records</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Test records when data missing</span>
        <span class="n">dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;file_records&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;exists&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">empty</span> <span class="o">=</span> <span class="n">datasets2records</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">empty</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">empty</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneAlyx.test_pid2eid"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneAlyx.test_pid2eid">[docs]</a>    <span class="k">def</span> <span class="nf">test_pid2eid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test OneAlyx.pid2eid&quot;&quot;&quot;</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="s1">&#39;b529f2d8-cdae-4d59-aba2-cbd1b5572e36&#39;</span>
        <span class="n">eid</span><span class="p">,</span> <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">pid2eid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;fc737f3c-2a57-4165-9763-905413e7e341&#39;</span><span class="p">,</span> <span class="n">eid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;probe00&#39;</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">pid2eid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneAlyx.test_describe_revision"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneAlyx.test_describe_revision">[docs]</a>    <span class="nd">@unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;sys.stdout&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_describe_revision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_stdout</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test OneAlyx.describe_revision&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;remote&#39;</span>
        <span class="c1"># Choose a date in the past so as to not conflict with registration tests</span>
        <span class="n">record</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s1">&#39;Lorem ipsum dolor sit amet, consectetur adipiscing elit.&#39;</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;revisions&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">no_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">HTTPError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;revisions&#39;</span><span class="p">,</span> <span class="s1">&#39;create&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">record</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">describe_revision</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">],</span> <span class="n">mock_stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">describe_revision</span><span class="p">(</span><span class="s1">&#39;foobar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;not found&#39;</span> <span class="ow">in</span> <span class="n">mock_stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>

        <span class="c1"># Check full kwarg</span>
        <span class="n">full</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">describe_revision</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">full</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>

        <span class="c1"># Check raises non-404 error</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">HTTPError</span><span class="p">()</span>
        <span class="n">err</span><span class="o">.</span><span class="n">response</span> <span class="o">=</span> <span class="n">Bunch</span><span class="p">({</span><span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">})</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">side_effect</span><span class="o">=</span><span class="n">err</span><span class="p">),</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">HTTPError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">describe_revision</span><span class="p">(</span><span class="n">record</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="TestOneAlyx.test_describe_dataset"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneAlyx.test_describe_dataset">[docs]</a>    <span class="nd">@unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;sys.stdout&#39;</span><span class="p">,</span> <span class="n">new_callable</span><span class="o">=</span><span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_describe_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_stdout</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test OneAlyx.describe_dataset.</span>
<span class="sd">        NB This could be offline: REST responses in fixtures.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;remote&#39;</span>
        <span class="c1"># Test all datasets</span>
        <span class="n">dset_types</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">describe_dataset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dset_types</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span> <span class="n">dset_types</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

        <span class="c1"># Test dataset type</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">describe_dataset</span><span class="p">(</span><span class="s1">&#39;wheel.velocity&#39;</span><span class="p">)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;Signed velocity of wheel&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">expected</span> <span class="ow">in</span> <span class="n">mock_stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>

        <span class="c1"># Test dataset name</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;amplitude of the wheel move&#39;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">describe_dataset</span><span class="p">(</span><span class="s1">&#39;_ibl_wheelMoves.peakAmplitude.npy&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">expected</span> <span class="ow">in</span> <span class="n">mock_stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">])</span>

        <span class="c1"># Test unknown dataset name</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">describe_dataset</span><span class="p">(</span><span class="s1">&#39;_ibl_foo.bar.baz&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneAlyx.test_url_from_path"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneAlyx.test_url_from_path">[docs]</a>    <span class="k">def</span> <span class="nf">test_url_from_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test OneAlyx.path2url&quot;&quot;&quot;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;cortexlab&#39;</span><span class="p">,</span> <span class="s1">&#39;Subjects&#39;</span><span class="p">,</span> <span class="s1">&#39;KS005&#39;</span><span class="p">,</span> <span class="s1">&#39;2019-04-04&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;004&#39;</span><span class="p">,</span> <span class="s1">&#39;alf&#39;</span><span class="p">,</span> <span class="s1">&#39;_ibl_wheel.position.npy&#39;</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">path2url</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">HTTP_DATA_SERVER</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;91546fc6-b67c-4a69-badc-5e66088519c4&#39;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">)</span>
        <span class="c1"># Check remote mode</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">path2url</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="c1"># Local data server path ends with &#39;/public&#39;; remote path does not</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">HTTP_DATA_SERVER</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;_fake_obj.attr.npy&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">path2url</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
        <span class="c1"># Check remote mode  FIXME Different behaviour between remote and local modes</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFObjectNotFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">path2url</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneAlyx.test_url_from_record"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneAlyx.test_url_from_record">[docs]</a>    <span class="k">def</span> <span class="nf">test_url_from_record</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test ConversionMixin.record2url&quot;&quot;&quot;</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;91546fc6-b67c-4a69-badc-5e66088519c4&#39;</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">record2url</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;https://ibl.flatironinstitute.org/public/&#39;</span>
                    <span class="s1">&#39;cortexlab/Subjects/KS005/2019-04-04/004/alf/&#39;</span>
                    <span class="s1">&#39;_ibl_wheel.position.91546fc6-b67c-4a69-badc-5e66088519c4.npy&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneAlyx.test_load_cache"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneAlyx.test_load_cache">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test loading the remote cache&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">silent</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># For checking log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;expired&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;one.api&#39;</span><span class="p">),</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span> <span class="k">as</span> <span class="n">lg</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">side_effect</span><span class="o">=</span><span class="n">HTTPError</span><span class="p">()):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_cache</span><span class="p">(</span><span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;remote&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">lg</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;cache over .+ old&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;Failed to load&#39;</span> <span class="ow">in</span> <span class="n">lg</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">side_effect</span><span class="o">=</span><span class="ne">ConnectionError</span><span class="p">()):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_cache</span><span class="p">(</span><span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;Failed to connect&#39;</span> <span class="ow">in</span> <span class="n">lg</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">cache_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;min_api_version&#39;</span><span class="p">:</span> <span class="s1">&#39;200.0.0&#39;</span><span class="p">}</span>
            <span class="c1"># Check version verification</span>
            <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">cache_info</span><span class="p">),</span>\
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertWarns</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_cache</span><span class="p">(</span><span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Check cache tags</span>
            <span class="n">raw_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">_meta</span><span class="p">[</span><span class="s1">&#39;raw&#39;</span><span class="p">]</span>
            <span class="n">raw_meta</span><span class="p">[</span><span class="s1">&#39;sessions&#39;</span><span class="p">][</span><span class="s1">&#39;database_tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Q3-2020-TAG&#39;</span>
            <span class="n">raw_meta</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">][</span><span class="s1">&#39;database_tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ANOTHER_TAG&#39;</span>
            <span class="n">cache_info</span><span class="p">[</span><span class="s1">&#39;database_tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ANOTHER_TAG&#39;</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">cache_info</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_cache</span><span class="p">)</span>

            <span class="c1"># Check for warning when origins are mixed</span>
            <span class="n">raw_meta</span><span class="p">[</span><span class="s1">&#39;sessions&#39;</span><span class="p">][</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_meta</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">][</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;alyx&#39;</span>
            <span class="n">cache_info</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;public&#39;</span>
            <span class="n">cache_info</span><span class="p">[</span><span class="s1">&#39;min_api_version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__version__</span>
            <span class="n">cache_info</span><span class="p">[</span><span class="s1">&#39;date_created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
            <span class="n">raw_meta</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">][</span><span class="s1">&#39;database_tags&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Q3-2020-TAG&#39;</span>
            <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">cache_dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*.pqt&#39;</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="p">,</span> <span class="s1">&#39;download_cache_tables&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">files</span><span class="p">),</span> \
                    <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="p">,</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">cache_info</span><span class="p">),</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">assertWarns</span><span class="p">(</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s1">&#39;another origin&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_cache</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s1">&#39;ANOTHER_TAG&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_tables_dir</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;ANOTHER_TAG&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_tables_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">(),</span> <span class="s1">&#39;failed to create tag dir&#39;</span><span class="p">)</span>

            <span class="c1"># Check table_dir behaviour</span>
            <span class="n">prev_loc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_tables_dir</span>  <span class="c1"># should be same location as previous</span>
            <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="p">,</span> <span class="s1">&#39;download_cache_tables&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">files</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_cache</span><span class="p">(</span><span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">prev_loc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_tables_dir</span><span class="p">)</span>
            <span class="n">new_loc</span> <span class="o">=</span> <span class="n">prev_loc</span><span class="o">.</span><span class="n">parent</span>  <span class="c1"># user input should override default</span>
            <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="p">,</span> <span class="s1">&#39;download_cache_tables&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">files</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_cache</span><span class="p">(</span><span class="n">tables_dir</span><span class="o">=</span><span class="n">new_loc</span><span class="p">,</span> <span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_loc</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_tables_dir</span><span class="p">)</span>

        <span class="k">finally</span><span class="p">:</span>  <span class="c1"># Restore properties</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">silent</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="TestOneAlyx.test_check_filesystem"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneAlyx.test_check_filesystem">[docs]</a>    <span class="k">def</span> <span class="nf">test_check_filesystem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for One._check_filesystem.</span>
<span class="sd">        Most is already covered by other tests, this just checks that it can deal with dataset</span>
<span class="sd">        dicts as input.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eid</span> <span class="o">=</span> <span class="s1">&#39;d3372b15-f696-4279-9be5-98f15783b5bb&#39;</span>
        <span class="n">dataset_type</span> <span class="o">=</span> <span class="s1">&#39;probes.description&#39;</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;datasets&#39;</span><span class="p">,</span> <span class="s1">&#39;list&#39;</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">eid</span><span class="p">,</span> <span class="n">dataset_type</span><span class="o">=</span><span class="n">dataset_type</span><span class="p">)</span>
        <span class="c1"># Create file on disk</span>
        <span class="n">file_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">eid2path</span><span class="p">(</span><span class="n">eid</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;alf&#39;</span><span class="p">,</span> <span class="s1">&#39;probes.description.json&#39;</span><span class="p">)</span>
        <span class="n">file_</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">file_</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
        <span class="c1"># Test method</span>
        <span class="n">file</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_check_filesystem</span><span class="p">(</span><span class="n">dsets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">file</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneAlyx.test_download_aws"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneAlyx.test_download_aws">[docs]</a>    <span class="nd">@mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;boto3.Session&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_download_aws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boto3_mock</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Tests for the OneAlyx._download_aws method&quot;&quot;&quot;</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="n">N</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dsets</span><span class="p">[</span><span class="s1">&#39;exists_aws&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>  <span class="c1"># Can&#39;t download in local mode</span>

        <span class="c1"># Return a file size so progress bar callback hook functions</span>
        <span class="n">file_object</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>
        <span class="n">file_object</span><span class="o">.</span><span class="n">content_length</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="n">boto3_mock</span><span class="p">()</span><span class="o">.</span><span class="n">resource</span><span class="p">()</span><span class="o">.</span><span class="n">Object</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="n">file_object</span>

        <span class="c1"># Mock _download_dataset for safety: method should not be called</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">,</span> <span class="s1">&#39;_download_dataset&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fallback_method</span><span class="p">:</span>
            <span class="n">out_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_datasets</span><span class="p">(</span><span class="n">dsets</span><span class="p">)</span>
            <span class="n">fallback_method</span><span class="o">.</span><span class="n">assert_not_called</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out_paths</span><span class="p">),</span> <span class="n">N</span><span class="p">,</span> <span class="s1">&#39;Returned list should equal length of input datasets&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">out_paths</span><span class="p">))</span>
        <span class="c1"># These values come from REST cache fixture</span>
        <span class="n">boto3_mock</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">aws_access_key_id</span><span class="o">=</span><span class="s1">&#39;ABCDEF&#39;</span><span class="p">,</span> <span class="n">aws_secret_access_key</span><span class="o">=</span><span class="s1">&#39;shhh&#39;</span><span class="p">,</span>
                                      <span class="n">region_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="p">((</span><span class="n">bucket</span><span class="p">,</span> <span class="n">path</span><span class="p">),</span> <span class="n">_</span><span class="p">),</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">boto3_mock</span><span class="p">()</span><span class="o">.</span><span class="n">resource</span><span class="p">()</span><span class="o">.</span><span class="n">Object</span><span class="o">.</span><span class="n">call_args_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="s1">&#39;s3_bucket&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">dsets</span><span class="p">[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">path</span><span class="p">,</span> <span class="s1">&#39;Dataset UUID not in filepath&#39;</span><span class="p">)</span>

        <span class="c1"># Should fall back to usual method if any datasets do not exist on AWS</span>
        <span class="n">dsets</span><span class="p">[</span><span class="s1">&#39;exists_aws&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">,</span> <span class="s1">&#39;_download_dataset&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fallback_method</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_datasets</span><span class="p">(</span><span class="n">dsets</span><span class="p">)</span>
            <span class="n">fallback_method</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span></div>

<div class="viewcode-block" id="TestOneAlyx.tearDownClass"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneAlyx.tearDownClass">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">tearDownClass</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TestOneRemote"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneRemote">[docs]</a><span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="n">OFFLINE_ONLY</span><span class="p">,</span> <span class="s1">&#39;online only test&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestOneRemote</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test remote queries&quot;&quot;&quot;</span>
<div class="viewcode-block" id="TestOneRemote.setUp"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneRemote.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span> <span class="o">=</span> <span class="n">OneAlyx</span><span class="p">(</span><span class="o">**</span><span class="n">TEST_DB_2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eid</span> <span class="o">=</span> <span class="s1">&#39;4ecb5d24-f5cc-402c-be28-9d0f7cb14b3a&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="s1">&#39;da8dfec1-d265-44e8-84ce-6ae9c109b8bd&#39;</span>
        <span class="c1"># Set cache directory to a temp dir to ensure that we re-download files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">_par</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;CACHE_DIR&#39;</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestOneRemote.test_online_repr"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneRemote.test_online_repr">[docs]</a>    <span class="k">def</span> <span class="nf">test_online_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tests OneAlyx.__repr__&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;online&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestOneRemote.test_list_datasets"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneRemote.test_list_datasets">[docs]</a>    <span class="k">def</span> <span class="nf">test_list_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test OneAlyx.list_datasets&quot;&quot;&quot;</span>
        <span class="c1"># Test list for eid</span>
        <span class="c1"># Ensure remote by making local datasets table empty</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_cache</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">166</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">))</span>

        <span class="c1"># Test missing eid</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="s1">&#39;FMR019/2021-03-18/008&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Test empty datasets</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.util.ses2records&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(),</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">())):</span>
            <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Test details=False, with eid</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">166</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">))</span>

        <span class="c1"># Test with other filters</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="s1">&#39;*probe*&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;*channels*&#39;</span><span class="p">,</span>
                                       <span class="n">details</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;probe&#39;</span><span class="p">,</span> <span class="s1">&#39;channels&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">dsets</span><span class="p">))</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertWarns</span><span class="p">(</span><span class="ne">Warning</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneRemote.test_search"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneRemote.test_search">[docs]</a>    <span class="k">def</span> <span class="nf">test_search</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test OneAlyx.search method in remote mode.&quot;&quot;&quot;</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="s1">&#39;SWC_043&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">eids</span><span class="p">))</span>

        <span class="n">eids</span><span class="p">,</span> <span class="n">det</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="s1">&#39;SWC_043&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">det</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">eids</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;url&#39;</span> <span class="ow">in</span> <span class="n">det</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">det</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">eids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">correct</span><span class="p">)</span>

        <span class="c1"># Check minimum set of keys present (these are present in One.search output)</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lab&#39;</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">,</span> <span class="s1">&#39;projects&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">expected</span><span class="p">)</span>
        <span class="c1"># Test dataset search with Django</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="s1">&#39;SWC_043&#39;</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;probes.description&#39;</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                               <span class="n">django</span><span class="o">=</span><span class="s1">&#39;data_dataset_session_related__collection__iexact,alf&#39;</span><span class="p">,</span>
                               <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">eids</span><span class="p">))</span>

        <span class="c1"># Test date range</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="s1">&#39;SWC_043&#39;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="s1">&#39;2020-09-21&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">eids</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">])</span>

        <span class="n">date_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">22</span><span class="p">)]</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="n">date_range</span><span class="p">,</span> <span class="n">lab</span><span class="o">=</span><span class="s1">&#39;hoferlab&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">eids</span><span class="p">))</span>
        <span class="n">dates</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">get_details</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">eids</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">dates</span> <span class="o">&lt;=</span> <span class="nb">set</span><span class="p">(</span><span class="n">date_range</span><span class="p">))</span>

        <span class="c1"># Test limit arg and LazyId</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="s1">&#39;2020-03-23&#39;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">eids</span><span class="p">,</span> <span class="n">LazyId</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">36</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">eids</span><span class="p">))</span>

        <span class="c1"># Test laboratory kwarg</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">laboratory</span><span class="o">=</span><span class="s1">&#39;hoferlab&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">eids</span><span class="p">))</span>

        <span class="n">eids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">lab</span><span class="o">=</span><span class="s1">&#39;hoferlab&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">eids</span><span class="p">))</span>

        <span class="c1"># Test dataset and dataset_types kwargs</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;trials.table.pqt&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">eids</span><span class="p">))</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;trials.intervals.npy&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">eids</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;wheel.times&#39;</span><span class="p">],</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>

        <span class="n">eids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">dataset_type</span><span class="o">=</span><span class="s1">&#39;trials.table.pqt&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">eids</span><span class="p">))</span>
        <span class="n">eids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">dataset_type</span><span class="o">=</span><span class="s1">&#39;trials.table&#39;</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="s1">&#39;2020-09-21&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">eids</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestOneRemote.test_search_insertions"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneRemote.test_search_insertions">[docs]</a>    <span class="k">def</span> <span class="nf">test_search_insertions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test OneAlyx.search_insertion method in remote mode.&quot;&quot;&quot;</span>

        <span class="c1"># Test search on subject</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search_insertions</span><span class="p">(</span><span class="n">subject</span><span class="o">=</span><span class="s1">&#39;SWC_043&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">pids</span><span class="p">))</span>

        <span class="c1"># Test search on session with details</span>
        <span class="n">pids</span><span class="p">,</span> <span class="n">det</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search_insertions</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">pids</span><span class="p">))</span>
        <span class="n">correct</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">det</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">pids</span><span class="p">)</span> <span class="ow">and</span> <span class="s1">&#39;id&#39;</span> <span class="ow">in</span> <span class="n">det</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="n">det</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">correct</span><span class="p">)</span>

        <span class="c1"># Test search on session and insertion name</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search_insertions</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;probe00&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>

        <span class="c1"># Test search with acronym</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search_insertions</span><span class="p">(</span><span class="n">atlas_acronym</span><span class="o">=</span><span class="s1">&#39;STR&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">pids</span><span class="p">))</span>

        <span class="c1"># Expect this list of acronyms to return nothing</span>
        <span class="n">pids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search_insertions</span><span class="p">(</span><span class="n">atlas_acronym</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;STR&#39;</span><span class="p">,</span> <span class="s1">&#39;CA3&#39;</span><span class="p">],</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">pids</span><span class="p">))</span>

        <span class="c1"># Test &#39;special&#39; params (these have different names on the REST side)</span>
        <span class="c1"># - full &#39;laboratory&#39; word</span>
        <span class="c1"># - &#39;dataset&#39; as singular with fuzzy match</span>
        <span class="c1"># - &#39;number&#39; -&gt; &#39;experiment_number&#39;</span>
        <span class="n">lab</span> <span class="o">=</span> <span class="s1">&#39;cortexlab&#39;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">det</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search_insertions</span><span class="p">(</span>
            <span class="n">laboratory</span><span class="o">=</span><span class="n">lab</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="s1">&#39;_ibl_log.info&#39;</span><span class="p">,</span>
            <span class="n">atlas_acronym</span><span class="o">=</span><span class="s1">&#39;STR&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">det</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">({</span><span class="n">lab</span><span class="p">},</span> <span class="p">{</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;session_info&#39;</span><span class="p">][</span><span class="s1">&#39;lab&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">det</span><span class="p">})</span>

        <span class="c1"># Test mode and field validation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search_insertions</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search_insertions</span><span class="p">,</span>
                          <span class="n">dataset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;wheel.times&#39;</span><span class="p">],</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneRemote.test_search_terms"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneRemote.test_search_terms">[docs]</a>    <span class="k">def</span> <span class="nf">test_search_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test OneAlyx.search_terms&quot;&quot;&quot;</span>
        <span class="n">search1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search_terms</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;dataset&#39;</span><span class="p">,</span> <span class="n">search1</span><span class="p">)</span>

        <span class="n">search2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search_terms</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;sessions&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">search1</span><span class="p">,</span> <span class="n">search2</span><span class="p">)</span>

        <span class="n">search3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search_terms</span><span class="p">(</span><span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;sessions&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;django&#39;</span><span class="p">,</span> <span class="n">search3</span><span class="p">)</span>

        <span class="n">search4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search_terms</span><span class="p">(</span><span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;insertions&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">search4</span><span class="p">)</span>

        <span class="n">search5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">search_terms</span><span class="p">(</span><span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;insertions&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">search5</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneRemote.test_load_dataset"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneRemote.test_load_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test OneAlyx.load_dataset&quot;&quot;&quot;</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;_spikeglx_sync.channels.npy&#39;</span><span class="p">,</span>
                                     <span class="n">collection</span><span class="o">=</span><span class="s1">&#39;raw_ephys_data&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">,</span>
                                     <span class="n">download_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;raw_ephys_data/_spikeglx_sync.channels.npy&#39;</span><span class="p">))</span>
        <span class="c1"># Test validations</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFMultipleCollectionsFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;spikes.clusters&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFMultipleObjectsFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;_iblrig_*Camera.raw&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFObjectNotFound</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;_iblrig_encoderEvents.raw.ssv&#39;</span><span class="p">,</span>
                                  <span class="n">collection</span><span class="o">=</span><span class="s1">&#39;alf&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneRemote.test_load_object"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneRemote.test_load_object">[docs]</a>    <span class="k">def</span> <span class="nf">test_load_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test OneAlyx.load_object&quot;&quot;&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="s1">&#39;wheel&#39;</span><span class="p">,</span>
                                     <span class="n">collection</span><span class="o">=</span><span class="s1">&#39;alf&#39;</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">,</span>
                                     <span class="n">download_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span>
            <span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;SWC_043/2020-09-21/001/alf/_ibl_wheel.position.npy&#39;</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TestOneRemote.test_get_details"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneRemote.test_get_details">[docs]</a>    <span class="k">def</span> <span class="nf">test_get_details</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test OneAlyx.get_details&quot;&quot;&quot;</span>
        <span class="n">det</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">get_details</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">query_type</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;SWC_043&#39;</span><span class="p">,</span> <span class="n">det</span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;ibl_neuropixel_brainwide_01&#39;</span><span class="p">,</span> <span class="n">det</span><span class="p">[</span><span class="s1">&#39;projects&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;2020-09-21&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">det</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">det</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s1">&#39;data_dataset_session_related&#39;</span><span class="p">,</span> <span class="n">det</span><span class="p">)</span>

        <span class="c1"># Test list</span>
        <span class="n">det</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">get_details</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">],</span> <span class="n">full</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;data_dataset_session_related&#39;</span><span class="p">,</span> <span class="n">det</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="TestOneDownload"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneDownload">[docs]</a><span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="n">OFFLINE_ONLY</span><span class="p">,</span> <span class="s1">&#39;online only test&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestOneDownload</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test downloading datasets using OpenAlyx&quot;&quot;&quot;</span>
    <span class="n">tempdir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">one</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="TestOneDownload.setUp"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneDownload.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.params.iopar.getfile&#39;</span><span class="p">,</span>
                                <span class="n">new</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">get_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span> <span class="o">=</span> <span class="n">OneAlyx</span><span class="p">(</span><span class="o">**</span><span class="n">TEST_DB_2</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fid</span> <span class="o">=</span> <span class="s1">&#39;17ab5b57-aaf6-4016-9251-66daadc200c7&#39;</span>  <span class="c1"># File record of channels.brainLocation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eid</span> <span class="o">=</span> <span class="s1">&#39;aad23144-0e52-4eac-80c5-c4ee2decb198&#39;</span></div>

<div class="viewcode-block" id="TestOneDownload.test_download_datasets"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneDownload.test_download_datasets">[docs]</a>    <span class="k">def</span> <span class="nf">test_download_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test OneAlyx._download_dataset, _download_file and _dset2url&quot;&quot;&quot;</span>
        <span class="n">det</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">get_details</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">det</span><span class="p">[</span><span class="s1">&#39;data_dataset_session_related&#39;</span><span class="p">]</span>
                   <span class="k">if</span> <span class="s1">&#39;channels.brainLocation&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;dataset_type&#39;</span><span class="p">])</span>
        <span class="c1"># FIXME hack because data_url may be AWS</span>
        <span class="kn">from</span> <span class="nn">one.alf.files</span> <span class="kn">import</span> <span class="n">get_alf_path</span>
        <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;data_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rel_path2url</span><span class="p">(</span><span class="n">get_alf_path</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;data_url&#39;</span><span class="p">]))</span>
        <span class="c1"># FIXME order may not be stable, this only works</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_dataset</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>

        <span class="n">url</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;data_url&#39;</span><span class="p">]</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_dataset</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_dataset</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="c1"># Check behaviour when hash mismatch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">silent</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># So we can check for warning</span>
        <span class="n">file_hash</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;hash&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
        <span class="c1"># Check three things:</span>
        <span class="c1"># 1. The mismatch should be logged at the debug level</span>
        <span class="c1"># 2. As we don&#39;t have permission to update this db we should see a failure warning</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;one.api&#39;</span><span class="p">),</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">),</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">assertWarns</span><span class="p">(</span><span class="ne">Warning</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;files/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_dataset</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">file_hash</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">silent</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Remove console clutter</span>

        <span class="c1"># Check JSON field added</span>
        <span class="c1"># 3. The files endpoint should be called with a &#39;mismatch_hash&#39; json key</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;files/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}]</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="p">,</span> <span class="s1">&#39;_generic_request&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">fr</span><span class="p">)</span> <span class="k">as</span> <span class="n">patched</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_dataset</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="nb">hash</span><span class="o">=</span><span class="n">file_hash</span><span class="p">)</span>
            <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">patched</span><span class="o">.</span><span class="n">call_args</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{}),</span> <span class="p">{</span><span class="s1">&#39;json&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;mismatch_hash&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}})</span>

        <span class="c1"># Check keep_uuid kwarg</span>
        <span class="c1"># FIXME Another hack: for this to work the file records order must be correct.</span>
        <span class="n">fi</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;file_records&#39;</span><span class="p">])</span>
                  <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;data_url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">HTTP_DATA_SERVER</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">fi</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;file_records&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;file_records&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">fi</span><span class="p">),</span> <span class="o">*</span><span class="n">rec</span><span class="p">[</span><span class="s1">&#39;file_records&#39;</span><span class="p">]]</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_dataset</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">keep_uuid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Check list input</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_dataset</span><span class="p">([</span><span class="n">rec</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">))</span>

        <span class="c1"># Check Series input</span>
        <span class="n">r_</span> <span class="o">=</span> <span class="n">datasets2records</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">int_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_dataset</span><span class="p">(</span><span class="n">r_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s1">&#39;channels.brainLocation&#39;</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>

        <span class="c1"># Check behaviour when URL invalid</span>
        <span class="n">did</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">did</span><span class="p">),</span> <span class="s1">&#39;exists&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;file_records&#39;</span><span class="p">]:</span>
            <span class="n">fr</span><span class="p">[</span><span class="s1">&#39;data_url&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_dataset</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">did</span><span class="p">),</span> <span class="s1">&#39;exists&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="c1"># With multiple dsets</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_dataset</span><span class="p">([</span><span class="n">rec</span><span class="p">,</span> <span class="n">rec</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">did</span><span class="p">),</span> <span class="s1">&#39;exists&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Reset values</span>

        <span class="c1"># Check with invalid path</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">cache_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;lab&#39;</span><span class="p">,</span> <span class="s1">&#39;Subjects&#39;</span><span class="p">,</span> <span class="s1">&#39;subj&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;001&#39;</span><span class="p">,</span>
                                           <span class="s1">&#39;spikes.times.npy&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;one.api&#39;</span><span class="p">),</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">):</span>
            <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_dataset</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="n">rec</span><span class="o">.</span><span class="n">rel_path</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;00/pykilosort/channels.brainLocation&#39;</span><span class="p">)]</span>
        <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;exists_aws&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Ensure we use FlatIron for this</span>
        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_datasets</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="kc">None</span> <span class="ow">in</span> <span class="n">files</span><span class="p">)</span>

        <span class="c1"># Check update cache when id is int and cache table ids are str</span>
        <span class="n">int_id</span><span class="p">,</span> <span class="o">=</span> <span class="n">parquet</span><span class="o">.</span><span class="n">str2np</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_dataset</span><span class="p">({</span><span class="s1">&#39;data_url&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">int_id</span><span class="p">)})</span>
        <span class="n">exists</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">rec</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">&#39;exists&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">exists</span><span class="p">,</span> <span class="s1">&#39;failed to update dataset cache with str index&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="n">rec</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s1">&#39;exists&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Reset values</span>

        <span class="c1"># Check works with int index</span>
        <span class="n">util</span><span class="o">.</span><span class="n">caches_str2int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_dataset</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNotNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_datasets</span><span class="p">(</span><span class="n">rec</span><span class="p">))</span>
        <span class="c1"># and when dataset missing</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">,</span> <span class="s1">&#39;record2url&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_dataset</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()))</span>

        <span class="n">exists</span><span class="p">,</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="o">*</span><span class="n">int_id</span><span class="p">),</span> <span class="s1">&#39;exists&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">exists</span><span class="p">,</span> <span class="s1">&#39;failed to update dataset cache with str index&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneDownload.test_download_aws"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneDownload.test_download_aws">[docs]</a>    <span class="k">def</span> <span class="nf">test_download_aws</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for OneAlyx._download_aws method.&quot;&quot;&quot;</span>
        <span class="c1"># Test download datasets via AWS</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">cache_dir</span> <span class="o">/</span> <span class="n">dsets</span><span class="p">[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.remote.aws.get_s3_from_alyx&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span> \
                <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.remote.aws.s3_download_file&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">method</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_datasets</span><span class="p">(</span><span class="n">dsets</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dsets</span><span class="p">),</span> <span class="n">method</span><span class="o">.</span><span class="n">call_count</span><span class="p">)</span>

        <span class="c1"># Test behaviour when dataset not remotely accessible</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="n">dsets</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;datasets&#39;</span><span class="p">,</span> <span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">dsets</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">rec</span><span class="p">[</span><span class="s1">&#39;file_records&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;exists&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Set AWS file record to non-existent</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.remote.aws.get_s3_from_alyx&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span> \
                <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="p">,</span> <span class="s1">&#39;rest&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="p">[</span><span class="n">rec</span><span class="p">]),</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="s1">&#39;one.api&#39;</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span> <span class="k">as</span> <span class="n">log</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="kc">None</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_datasets</span><span class="p">(</span><span class="n">dsets</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;Updating exists field&#39;</span><span class="p">)</span>
            <span class="n">datasets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="s1">&#39;datasets&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span>
                <span class="n">datasets</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span><span class="p">[:,</span> <span class="n">dsets</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="s1">&#39;exists_aws&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="c1"># When using integer IDs we should fallback to HTTP downloads</span>
        <span class="n">util</span><span class="o">.</span><span class="n">caches_str2int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span>  <span class="c1"># Convert to integer IDs</span>
        <span class="n">dsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eid</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dsets</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;exists_aws&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.remote.aws.get_s3_from_alyx&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)),</span> \
                <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="p">,</span> <span class="s1">&#39;_download_dataset&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">method</span><span class="p">,</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="s1">&#39;one.api&#39;</span><span class="p">,</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span> <span class="k">as</span> <span class="n">log</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_download_datasets</span><span class="p">(</span><span class="n">dsets</span><span class="p">)</span>
            <span class="n">method</span><span class="o">.</span><span class="n">assert_called</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Downloading from AWS&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">log</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;AWS download only supported for str index cache&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneDownload.test_tag_mismatched_file_record"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneDownload.test_tag_mismatched_file_record">[docs]</a>    <span class="k">def</span> <span class="nf">test_tag_mismatched_file_record</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test for OneAlyx._tag_mismatched_file_record.</span>
<span class="sd">        This method is also tested in test_download_datasets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">did</span> <span class="o">=</span> <span class="s1">&#39;4a1500c2-60f3-418f-afa2-c752bb1890f0&#39;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;https://example.com/channels.brainLocationIds_ccf_2017.</span><span class="si">{</span><span class="n">did</span><span class="si">}</span><span class="s1">.npy&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;json&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;mismatch_hash&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span> <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;https://example.com/files/</span><span class="si">{</span><span class="n">did</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}]</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">object</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="p">,</span> <span class="s1">&#39;rest&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="n">data</span><span class="p">)</span> <span class="k">as</span> <span class="n">mk</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">_tag_mismatched_file_record</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;json&#39;</span><span class="p">][</span><span class="s1">&#39;mismatch_hash&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">mk</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="s1">&#39;partial_update&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">did</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;json&#39;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;json&#39;</span><span class="p">]})</span></div>

<div class="viewcode-block" id="TestOneDownload.tearDown"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneDownload.tearDown">[docs]</a>    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># In case we did indeed have remote REST permissions, try resetting the json field</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">one</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">rest</span><span class="p">(</span><span class="s1">&#39;files&#39;</span><span class="p">,</span> <span class="s1">&#39;partial_update&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;json&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">})</span>
        <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ex</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="mi">403</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patch</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="TestOneSetup"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneSetup">[docs]</a><span class="k">class</span> <span class="nc">TestOneSetup</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test parameter setup upon ONE instantiation and calling setup methods&quot;&quot;&quot;</span>
<div class="viewcode-block" id="TestOneSetup.setUp"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneSetup.setUp">[docs]</a>    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">cleanup</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_file</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">get_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># Change default cache dir to temporary directory</span>
        <span class="n">patch</span> <span class="o">=</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.params.CACHE_DIR_DEFAULT&#39;</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="n">patch</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">patch</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneSetup.test_local_cache_setup_prompt"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneSetup.test_local_cache_setup_prompt">[docs]</a>    <span class="k">def</span> <span class="nf">test_local_cache_setup_prompt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test One.setup&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;spikes.times.npy&#39;</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">path</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.input&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
            <span class="n">one_obj</span> <span class="o">=</span> <span class="n">One</span><span class="o">.</span><span class="n">setup</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">one_obj</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;spikes.times.npy&#39;</span><span class="p">])</span>

        <span class="c1"># Check prompts warns about cache existing</span>
        <span class="n">path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;spikes.clusters.npy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>
        <span class="n">one_obj</span> <span class="o">=</span> <span class="n">One</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">one_obj</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">()))</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;builtins.input&#39;</span><span class="p">,</span> <span class="n">side_effect</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]):</span>
            <span class="n">one_obj</span> <span class="o">=</span> <span class="n">One</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># Reply no to cache overwrite</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">one_obj</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">()))</span>
            <span class="n">one_obj</span> <span class="o">=</span> <span class="n">One</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>  <span class="c1"># Reply yes to cache overwrite</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">one_obj</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">()))</span>

        <span class="c1"># Test with no prompt</span>
        <span class="n">one_obj</span> <span class="o">=</span> <span class="n">One</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">one_obj</span><span class="o">.</span><span class="n">list_datasets</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span></div>

<div class="viewcode-block" id="TestOneSetup.test_setup_silent"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneSetup.test_setup_silent">[docs]</a>    <span class="k">def</span> <span class="nf">test_setup_silent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test setting up parameters with silent flag.</span>
<span class="sd">        - Mock getfile to return temp dir as param file location</span>
<span class="sd">        - Mock input function as fail safe in case function erroneously prompts user for input</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;iblutil.io.params.getfile&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">),</span>\
                <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.params.input&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">):</span>
            <span class="n">one_obj</span> <span class="o">=</span> <span class="n">ONE</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">one_obj</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">default</span><span class="p">()</span><span class="o">.</span><span class="n">ALYX_URL</span><span class="p">)</span>

        <span class="c1"># Check param files were saved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s1">&#39;.caches&#39;</span><span class="p">))),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">client_pars</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">one_obj</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">base_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">client_pars</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Check uses defaults on second instantiation</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;iblutil.io.params.getfile&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">):</span>
            <span class="n">one_obj</span> <span class="o">=</span> <span class="n">ONE</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">one_obj</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">default</span><span class="p">()</span><span class="o">.</span><span class="n">ALYX_URL</span><span class="p">)</span>

        <span class="c1"># Check saves base_url arg</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="s1">&#39;Test setup with base URL&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">OFFLINE_ONLY</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s1">&#39;Requires remote db connection&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;iblutil.io.params.getfile&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">):</span>
                <span class="n">one_obj</span> <span class="o">=</span> <span class="n">ONE</span><span class="p">(</span><span class="o">**</span><span class="n">TEST_DB_1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">one_obj</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">TEST_DB_1</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">])</span>
                <span class="n">params_url</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">TEST_DB_1</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">ALYX_URL</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">params_url</span><span class="p">,</span> <span class="n">one_obj</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">base_url</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneSetup.test_setup_username"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneSetup.test_setup_username">[docs]</a>    <span class="k">def</span> <span class="nf">test_setup_username</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test setting up parameters with a provided username.</span>
<span class="sd">        - Mock getfile to return temp dir as param file location</span>
<span class="sd">        - Mock input function as fail safe in case function erroneously prompts user for input</span>
<span class="sd">        - Mock requests.post returns a fake user authentication response</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">credentials</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="s1">&#39;foobar&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="s1">&#39;123&#39;</span><span class="p">}</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;iblutil.io.params.getfile&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">),</span>\
                <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.params.input&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">),</span>\
                <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.webclient.requests.post&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">req_mock</span><span class="p">:</span>
            <span class="n">req_mock</span><span class="p">()</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="s1">&#39;shhh&#39;</span><span class="p">}</span>
            <span class="c1"># In remote mode the cache endpoint will not be queried</span>
            <span class="n">one_obj</span> <span class="o">=</span> <span class="n">ONE</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="s1">&#39;https://test.alyx.internationalbrainlab.org&#39;</span><span class="p">,</span>
                          <span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">credentials</span><span class="p">)</span>
            <span class="n">params_username</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">TEST_DB_1</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">ALYX_LOGIN</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">params_username</span><span class="p">,</span> <span class="n">one_obj</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">credentials</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="n">one_obj</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">req_mock</span><span class="o">.</span><span class="n">call_args</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="p">{}),</span> <span class="n">credentials</span><span class="p">)</span>

            <span class="c1"># Reinstantiate as a different user</span>
            <span class="n">one_obj</span> <span class="o">=</span> <span class="n">ONE</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="s1">&#39;https://test.alyx.internationalbrainlab.org&#39;</span><span class="p">,</span>
                          <span class="n">username</span><span class="o">=</span><span class="s1">&#39;baz&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;123&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;remote&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">one_obj</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="s1">&#39;baz&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">one_obj</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">one_obj</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">ALYX_LOGIN</span><span class="p">)</span>
            <span class="c1"># After initial set up the username in the pars file should remain unchanged</span>
            <span class="n">params_username</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="n">TEST_DB_1</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">ALYX_LOGIN</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">one_obj</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">params_username</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneSetup.test_static_setup"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneSetup.test_static_setup">[docs]</a>    <span class="nd">@unittest</span><span class="o">.</span><span class="n">skipIf</span><span class="p">(</span><span class="n">OFFLINE_ONLY</span><span class="p">,</span> <span class="s1">&#39;online only test&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_static_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test OneAlyx.setup&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;iblutil.io.params.getfile&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">),</span>\
                <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.webclient.getpass&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="s1">&#39;international&#39;</span><span class="p">):</span>
            <span class="n">one_obj</span> <span class="o">=</span> <span class="n">OneAlyx</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">one_obj</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">default</span><span class="p">()</span><span class="o">.</span><span class="n">ALYX_URL</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneSetup.test_setup"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneSetup.test_setup">[docs]</a>    <span class="k">def</span> <span class="nf">test_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test one.params.setup&quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">TEST_DB_1</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">mock_input</span><span class="p">(</span><span class="n">prompt</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;warning&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mock_input</span><span class="p">,</span> <span class="s1">&#39;conflict_warn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>    <span class="c1"># Checks both responses</span>
                    <span class="n">mock_input</span><span class="o">.</span><span class="n">conflict_warn</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">return</span> <span class="s1">&#39;y&#39;</span>
                <span class="k">return</span> <span class="s1">&#39;n&#39;</span>
            <span class="k">elif</span> <span class="s1">&#39;download cache&#39;</span> <span class="ow">in</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;downloads&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>
            <span class="k">elif</span> <span class="s1">&#39;url&#39;</span> <span class="ow">in</span> <span class="n">prompt</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">url</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;mock_input&#39;</span>
        <span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">mock_input</span>
        <span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">getpass</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">prompt</span><span class="p">:</span> <span class="s1">&#39;mock_pwd&#39;</span>
        <span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">print</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">text</span><span class="p">:</span> <span class="s1">&#39;mock_print&#39;</span>
        <span class="c1"># Mock getfile function to return a path to non-existent file instead of usual one pars</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;iblutil.io.params.getfile&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">):</span>
            <span class="n">one_obj</span> <span class="o">=</span> <span class="n">OneAlyx</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">,</span>
                              <span class="n">username</span><span class="o">=</span><span class="n">TEST_DB_1</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
                              <span class="n">password</span><span class="o">=</span><span class="n">TEST_DB_1</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">])</span>
            <span class="n">pars</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="s1">&#39;ALYX_PWD&#39;</span> <span class="ow">in</span> <span class="n">pars</span><span class="o">.</span><span class="n">as_dict</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">one_obj</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">ALYX_URL</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
        <span class="n">client_pars</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;.</span><span class="si">{</span><span class="n">one_obj</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">base_url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">client_pars</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Save ALYX_PWD into params and see if setup modifies it</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;iblutil.io.params.getfile&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">):</span>
            <span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">pars</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;ALYX_PWD&#39;</span><span class="p">,</span> <span class="s1">&#39;foobar&#39;</span><span class="p">),</span> <span class="n">url</span><span class="p">)</span>
            <span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">ALYX_PWD</span><span class="p">,</span> <span class="s1">&#39;mock_pwd&#39;</span><span class="p">)</span>

        <span class="c1"># Check conflict warning</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;iblutil.io.params.getfile&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">):</span>
            <span class="n">OneAlyx</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">,</span>
                    <span class="n">base_url</span><span class="o">=</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;base_url&#39;</span><span class="p">],</span>
                    <span class="n">username</span><span class="o">=</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span>
                    <span class="n">password</span><span class="o">=</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">mock_input</span><span class="p">,</span> <span class="s1">&#39;conflict_warn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span></div>

<div class="viewcode-block" id="TestOneSetup.test_patch_params"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneSetup.test_patch_params">[docs]</a>    <span class="k">def</span> <span class="nf">test_patch_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test patching legacy params to the new location&quot;&quot;&quot;</span>
        <span class="c1"># Save some old-style params</span>
        <span class="n">old_pars</span> <span class="o">=</span> <span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">default</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;HTTP_DATA_SERVER&#39;</span><span class="p">,</span> <span class="s1">&#39;openalyx.org&#39;</span><span class="p">)</span>
        <span class="c1"># Save a REST query in the old location</span>
        <span class="n">old_rest</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;.one&#39;</span><span class="p">,</span> <span class="s1">&#39;.rest&#39;</span><span class="p">,</span> <span class="n">old_pars</span><span class="o">.</span><span class="n">ALYX_URL</span><span class="p">[</span><span class="mi">8</span><span class="p">:],</span> <span class="s1">&#39;https&#39;</span><span class="p">)</span>
        <span class="n">old_rest</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">old_rest</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;1baff95c2d0e31059720a3716ad5b5a34b61a207&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">touch</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;iblutil.io.params.getfile&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">):</span>
            <span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">old_pars</span><span class="p">,</span> <span class="n">old_pars</span><span class="o">.</span><span class="n">ALYX_URL</span><span class="p">)</span>
            <span class="n">one_obj</span> <span class="o">=</span> <span class="n">ONE</span><span class="p">(</span><span class="n">base_url</span><span class="o">=</span><span class="n">old_pars</span><span class="o">.</span><span class="n">ALYX_URL</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">one_obj</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">_par</span><span class="o">.</span><span class="n">HTTP_DATA_SERVER</span><span class="p">,</span> <span class="n">one</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">default</span><span class="p">()</span><span class="o">.</span><span class="n">HTTP_DATA_SERVER</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;.rest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="n">one_obj</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">cache_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;.rest&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)))</span></div>

<div class="viewcode-block" id="TestOneSetup.test_one_factory"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneSetup.test_one_factory">[docs]</a>    <span class="k">def</span> <span class="nf">test_one_factory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Tests the ONE class factory&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;iblutil.io.params.getfile&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_file</span><span class="p">),</span>\
                <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;one.params.input&#39;</span><span class="p">,</span> <span class="n">new</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">):</span>
            <span class="c1"># Cache dir not in client cache map; use One (light)</span>
            <span class="n">one_obj</span> <span class="o">=</span> <span class="n">ONE</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">one_obj</span><span class="p">,</span> <span class="n">One</span><span class="p">)</span>

            <span class="c1"># The offline param was given, raise deprecation warning (via log)</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertWarns</span><span class="p">(</span><span class="ne">DeprecationWarning</span><span class="p">):</span>
                <span class="n">ONE</span><span class="p">(</span><span class="n">offline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cache_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tempdir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="c1"># Test setup with virtual ONE method</span>
            <span class="k">assert</span> <span class="n">ONE</span><span class="o">.</span><span class="n">cache_info</span><span class="p">()</span><span class="o">.</span><span class="n">currsize</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">ONE</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">make_default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">ONE</span><span class="o">.</span><span class="n">cache_info</span><span class="p">()</span><span class="o">.</span><span class="n">currsize</span><span class="p">,</span> <span class="s1">&#39;failed to reset LRU cache&#39;</span><span class="p">)</span>

            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="s1">&#39;ONE setup with database URL&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">OFFLINE_ONLY</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">skipTest</span><span class="p">(</span><span class="s1">&#39;Requires remote db connection&#39;</span><span class="p">)</span>
                <span class="c1"># No cache dir provided; use OneAlyx (silent setup mode)</span>
                <span class="n">one_obj</span> <span class="o">=</span> <span class="n">ONE</span><span class="p">(</span><span class="n">silent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">TEST_DB_2</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">one_obj</span><span class="p">,</span> <span class="n">OneAlyx</span><span class="p">)</span>

                <span class="c1"># The cache dir is in client cache map; use OneAlyx</span>
                <span class="n">one_obj</span> <span class="o">=</span> <span class="n">ONE</span><span class="p">(</span><span class="n">cache_dir</span><span class="o">=</span><span class="n">one_obj</span><span class="o">.</span><span class="n">alyx</span><span class="o">.</span><span class="n">cache_dir</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">one_obj</span><span class="p">,</span> <span class="n">OneAlyx</span><span class="p">)</span>

                <span class="c1"># A db URL was provided; use OneAlyx</span>
                <span class="c1"># mode = &#39;local&#39; ensures we don&#39;t download cache (could also set cache_dir)</span>
                <span class="n">one_obj</span> <span class="o">=</span> <span class="n">ONE</span><span class="p">(</span><span class="o">**</span><span class="n">TEST_DB_1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;local&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertIsInstance</span><span class="p">(</span><span class="n">one_obj</span><span class="p">,</span> <span class="n">OneAlyx</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TestOneMisc"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneMisc">[docs]</a><span class="k">class</span> <span class="nc">TestOneMisc</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Test functions in one.util&quot;&quot;&quot;</span>
<div class="viewcode-block" id="TestOneMisc.test_validate_date_range"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneMisc.test_validate_date_range">[docs]</a>    <span class="k">def</span> <span class="nf">test_validate_date_range</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test one.util.validate_date_range&quot;&quot;&quot;</span>
        <span class="c1"># Single string date</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">validate_date_range</span><span class="p">(</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">)</span>  <span class="c1"># On this day</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2020-01-01 00:00:00&#39;</span><span class="p">),</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2020-01-01 23:59:59.999000&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

        <span class="c1"># Single datetime.date object</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">validate_date_range</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2020-01-01 00:00:00&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

        <span class="c1"># Single pandas Timestamp</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">validate_date_range</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

        <span class="c1"># Array of two datetime64</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">validate_date_range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;2022-01-30&#39;</span><span class="p">,</span> <span class="s1">&#39;2022-01-30&#39;</span><span class="p">],</span>
                                              <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;datetime64[D]&#39;</span><span class="p">))</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2022-01-30 00:00:00&#39;</span><span class="p">),</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2022-01-30 00:00:00&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>

        <span class="c1"># From date (lower bound)</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">validate_date_range</span><span class="p">([</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">])</span>  <span class="c1"># from date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2020-01-01 00:00:00&#39;</span><span class="p">))</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">actual</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">365</span><span class="p">)</span>

        <span class="n">actual</span> <span class="o">=</span> <span class="n">validate_date_range</span><span class="p">([</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>  <span class="c1"># from date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2020-01-01 00:00:00&#39;</span><span class="p">))</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">actual</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">days</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">365</span><span class="p">)</span>  <span class="c1"># Upper bound at least 60 years in the future</span>

        <span class="c1"># To date (upper bound)</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="n">validate_date_range</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;2020-01-01&#39;</span><span class="p">])</span>  <span class="c1"># up to date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2020-01-01 00:00:00&#39;</span><span class="p">))</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">year</span> <span class="o">-</span> <span class="n">actual</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">year</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">)</span>  <span class="c1"># Lower bound at least 60 years in the past</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">validate_date_range</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">validate_date_range</span><span class="p">([</span><span class="s1">&#39;2020-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2019-09-06&#39;</span><span class="p">,</span> <span class="s1">&#39;2021-10-04&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="TestOneMisc.test_index_last_before"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneMisc.test_index_last_before">[docs]</a>    <span class="k">def</span> <span class="nf">test_index_last_before</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test one.util.index_last_before&quot;&quot;&quot;</span>
        <span class="n">revisions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2021-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-08-01&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;2020-09-30&#39;</span><span class="p">]</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">index_last_before</span><span class="p">(</span><span class="n">revisions</span><span class="p">,</span> <span class="s1">&#39;2021-01-01&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">verifiable</span><span class="p">)</span>

        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">index_last_before</span><span class="p">(</span><span class="n">revisions</span><span class="p">,</span> <span class="s1">&#39;2020-09-15&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">verifiable</span><span class="p">)</span>

        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">index_last_before</span><span class="p">(</span><span class="n">revisions</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">verifiable</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">index_last_before</span><span class="p">([],</span> <span class="s1">&#39;2009-01-01&#39;</span><span class="p">))</span>

        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">index_last_before</span><span class="p">(</span><span class="n">revisions</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">verifiable</span><span class="p">,</span> <span class="s1">&#39;should return most recent&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneMisc.test_collection_spec"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneMisc.test_collection_spec">[docs]</a>    <span class="k">def</span> <span class="nf">test_collection_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test one.util._collection_spec&quot;&quot;&quot;</span>
        <span class="c1"># Test every combination of input</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_collection</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="s1">&#39;(</span><span class="si">{collection}</span><span class="s1">/)?&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{collection}</span><span class="s1">/&#39;</span><span class="p">}</span>
        <span class="n">_revision</span> <span class="o">=</span> <span class="p">{</span><span class="kc">None</span><span class="p">:</span> <span class="s1">&#39;(#</span><span class="si">{revision}</span><span class="s1">#/)?&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">:</span> <span class="s1">&#39;#</span><span class="si">{revision}</span><span class="s1">#/&#39;</span><span class="p">}</span>
        <span class="n">combs</span> <span class="o">=</span> <span class="n">combinations_with_replacement</span><span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">[</span><span class="n">inputs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">permutations</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">combs</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">collection</span><span class="p">,</span> <span class="n">revision</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="n">collection</span><span class="o">=</span><span class="n">collection</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">revision</span><span class="p">):</span>
                <span class="n">verifiable</span> <span class="o">=</span> <span class="n">_collection_spec</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">revision</span><span class="p">)</span>
                <span class="n">expected</span> <span class="o">=</span> <span class="n">_collection</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span> <span class="o">+</span> <span class="n">_revision</span><span class="p">[</span><span class="n">revision</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">verifiable</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneMisc.test_revision_last_before"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneMisc.test_revision_last_before">[docs]</a>    <span class="k">def</span> <span class="nf">test_revision_last_before</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test one.util.filter_revision_last_before&quot;&quot;&quot;</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">revisions_datasets_table</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">datasets</span><span class="p">[</span><span class="n">datasets</span><span class="o">.</span><span class="n">rel_path</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;alf/probe00&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_revision_last_before</span><span class="p">(</span><span class="n">df</span><span class="p">,</span>
                                                 <span class="n">revision</span><span class="o">=</span><span class="s1">&#39;2020-09-01&#39;</span><span class="p">,</span> <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">verifiable</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Test assert unique</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFMultipleRevisionsFound</span><span class="p">):</span>
            <span class="n">filter_revision_last_before</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="s1">&#39;2020-09-01&#39;</span><span class="p">,</span> <span class="n">assert_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Test with default revisions</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;default_revision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertLogs</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;one.util&#39;</span><span class="p">)):</span>
            <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_revision_last_before</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">assert_unique</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">verifiable</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Should have fallen back on lexicographical ordering</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">verifiable</span><span class="o">.</span><span class="n">rel_path</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;#2021-07-06#&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFError</span><span class="p">):</span>
            <span class="n">filter_revision_last_before</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">assert_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Add unique default revisions</span>
        <span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">verifiable</span> <span class="o">=</span> <span class="n">filter_revision_last_before</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">assert_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">verifiable</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="n">verifiable</span><span class="p">[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rel_path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">]])</span>

        <span class="c1"># Add multiple default revisions</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;default_revision&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">alferr</span><span class="o">.</span><span class="n">ALFMultipleRevisionsFound</span><span class="p">):</span>
            <span class="n">filter_revision_last_before</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">assert_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneMisc.test_parse_id"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneMisc.test_parse_id">[docs]</a>    <span class="k">def</span> <span class="nf">test_parse_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test one.util.parse_id&quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">mock</span><span class="o">.</span><span class="n">MagicMock</span><span class="p">()</span>  <span class="c1"># Mock object to decorate</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">to_eid</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="s1">&#39;parsed_id&#39;</span>  <span class="c1"># Method to be called</span>
        <span class="nb">input</span> <span class="o">=</span> <span class="s1">&#39;subj/date/num&#39;</span>  <span class="c1"># Input id to pass to `to_eid`</span>
        <span class="n">parse_id</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">method</span><span class="p">)(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">to_eid</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;parsed_id&#39;</span><span class="p">)</span>

        <span class="c1"># Test raises value error when None returned</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">to_eid</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Simulate failure to parse id</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">parse_id</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">method</span><span class="p">)(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">input</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneMisc.test_autocomplete"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneMisc.test_autocomplete">[docs]</a>    <span class="k">def</span> <span class="nf">test_autocomplete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test one.util.autocomplete&quot;&quot;&quot;</span>
        <span class="n">search_terms</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;date_range&#39;</span><span class="p">,</span> <span class="s1">&#39;dataset&#39;</span><span class="p">,</span> <span class="s1">&#39;dataset_type&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="n">autocomplete</span><span class="p">(</span><span class="s1">&#39;Subj&#39;</span><span class="p">,</span> <span class="n">search_terms</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;dataset&#39;</span><span class="p">,</span> <span class="n">autocomplete</span><span class="p">(</span><span class="s1">&#39;dataset&#39;</span><span class="p">,</span> <span class="n">search_terms</span><span class="p">))</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">autocomplete</span><span class="p">(</span><span class="s1">&#39;dtypes&#39;</span><span class="p">,</span> <span class="n">search_terms</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">autocomplete</span><span class="p">(</span><span class="s1">&#39;dat&#39;</span><span class="p">,</span> <span class="n">search_terms</span><span class="p">)</span></div>

<div class="viewcode-block" id="TestOneMisc.test_LazyID"><a class="viewcode-back" href="../../../_autosummary/one.tests.test_one.html#one.tests.test_one.TestOneMisc.test_LazyID">[docs]</a>    <span class="k">def</span> <span class="nf">test_LazyID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Test one.util.LazyID&quot;&quot;&quot;</span>
        <span class="n">uuids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;c1a2758d-3ce5-4fa7-8d96-6b960f029fa9&#39;</span><span class="p">,</span>
            <span class="s1">&#39;0780da08-a12b-452a-b936-ebc576aa7670&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ff812ca5-ce60-44ac-b07e-66c2c37e98eb&#39;</span>
        <span class="p">]</span>
        <span class="n">ses</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;https://website.org/foo/</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">uuids</span><span class="p">]</span>
        <span class="n">ez</span> <span class="o">=</span> <span class="n">LazyId</span><span class="p">(</span><span class="n">ses</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">uuids</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ez</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ez</span><span class="p">),</span> <span class="n">uuids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ez</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">uuids</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ez</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">uuids</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">ez</span> <span class="o">=</span> <span class="n">LazyId</span><span class="p">([{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">uuids</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertCountEqual</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">ez</span><span class="p">),</span> <span class="n">uuids</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, International Brain Lab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>